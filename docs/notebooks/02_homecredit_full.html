<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Home Credit Default Risk Analysis (Full Dataset)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-393f40ce381bb45e949c987c174a7120.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#project-objective" id="toc-project-objective" class="nav-link active" data-scroll-target="#project-objective">Project Objective</a></li>
  <li><a href="#key-features" id="toc-key-features" class="nav-link" data-scroll-target="#key-features">Key Features</a></li>
  <li><a href="#why-catboost" id="toc-why-catboost" class="nav-link" data-scroll-target="#why-catboost">Why CatBoost?</a></li>
  <li><a href="#notebook-outline" id="toc-notebook-outline" class="nav-link" data-scroll-target="#notebook-outline">Notebook Outline</a></li>
  <li><a href="#section-1-data-loading-and-merging" id="toc-section-1-data-loading-and-merging" class="nav-link" data-scroll-target="#section-1-data-loading-and-merging">Section 1: Data loading and merging</a>
  <ul class="collapse">
  <li><a href="#raw-file-import" id="toc-raw-file-import" class="nav-link" data-scroll-target="#raw-file-import">1.1 Raw File Import</a></li>
  </ul></li>
  <li><a href="#section-2-relational-merging-workflow" id="toc-section-2-relational-merging-workflow" class="nav-link" data-scroll-target="#section-2-relational-merging-workflow">Section 2: Relational merging workflow</a></li>
  <li><a href="#section-3-sanity-checks-and-preprocessing" id="toc-section-3-sanity-checks-and-preprocessing" class="nav-link" data-scroll-target="#section-3-sanity-checks-and-preprocessing">Section 3: Sanity Checks and Preprocessing</a>
  <ul class="collapse">
  <li><a href="#trainvalidationtest-split" id="toc-trainvalidationtest-split" class="nav-link" data-scroll-target="#trainvalidationtest-split">3.1 Train/Validation/Test Split</a></li>
  <li><a href="#notes-inconsistencies-checked" id="toc-notes-inconsistencies-checked" class="nav-link" data-scroll-target="#notes-inconsistencies-checked">3.2 Notes / Inconsistencies Checked</a></li>
  </ul></li>
  <li><a href="#section-4-catboost-modeling" id="toc-section-4-catboost-modeling" class="nav-link" data-scroll-target="#section-4-catboost-modeling">Section 4: CatBoost Modeling</a>
  <ul class="collapse">
  <li><a href="#initial-run-baseline-catboost-model" id="toc-initial-run-baseline-catboost-model" class="nav-link" data-scroll-target="#initial-run-baseline-catboost-model">4.1 Initial Run (Baseline CatBoost Model)</a></li>
  <li><a href="#shap-feature-importance-summary" id="toc-shap-feature-importance-summary" class="nav-link" data-scroll-target="#shap-feature-importance-summary">6.7 SHAP Feature Importance Summary</a>
  <ul class="collapse">
  <li><a href="#global-feature-importance-mean-shap-values" id="toc-global-feature-importance-mean-shap-values" class="nav-link" data-scroll-target="#global-feature-importance-mean-shap-values">Global Feature Importance (Mean SHAP Values)</a></li>
  <li><a href="#shap-summary-plot-all-samples" id="toc-shap-summary-plot-all-samples" class="nav-link" data-scroll-target="#shap-summary-plot-all-samples">SHAP Summary Plot (All Samples)</a></li>
  <li><a href="#shap-by-feature-group" id="toc-shap-by-feature-group" class="nav-link" data-scroll-target="#shap-by-feature-group">SHAP by Feature Group</a></li>
  <li><a href="#shap-force-plots-individual-explanations" id="toc-shap-force-plots-individual-explanations" class="nav-link" data-scroll-target="#shap-force-plots-individual-explanations">SHAP Force Plots (Individual Explanations)</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Home Credit Default Risk Analysis (Full Dataset)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<hr>
<section id="project-objective" class="level2">
<h2 class="anchored" data-anchor-id="project-objective">Project Objective</h2>
<ul>
<li>This notebook presents a comprehensive end-to-end modeling pipeline for predicting default risk using the entire Home Credit dataset (not a sample). The goal is to identify clients who are likely to experience payment difficulties, based on extensive historical and application data.</li>
<li>We use CatBoost, a gradient boosting model particularly well-suited for handling categorical features natively, and apply Optuna to tune hyperparameters for maximum performance. This version of the notebook represents the final cleaned, tuned, and fully cross-validated model, ready for interpretation and, with further adjustments, deployment.</li>
</ul>
</section>
<section id="key-features" class="level2">
<h2 class="anchored" data-anchor-id="key-features">Key Features</h2>
<ul>
<li><strong>Data Source</strong>: <a href="https://www.kaggle.com/competitions/home-credit-default-risk/data">Kaggle - Home Credit Default Risk</a></li>
<li><strong>Data Used</strong>: All relevant relational tables merged and aggregated appropriately (<code>bureau</code>, <code>previous_application</code>, <code>installments_payments</code>, etc.)</li>
<li><strong>Target</strong>: <code>TARGET</code> (1 = client experienced payment difficulties, 0 = otherwise)</li>
<li><strong>Model</strong>: <a href="https://catboost.ai">CatBoostClassifier</a></li>
<li><strong>Tuning</strong>: <a href="https://optuna.org/">Optuna</a> hyperparameter optimization with stratified K-fold cross-validation</li>
<li><strong>Evaluation Metrics</strong>: AUC, Recall, Precision, F1-score, Confusion Matrix, and SHAP interpretability</li>
</ul>
</section>
<section id="why-catboost" class="level2">
<h2 class="anchored" data-anchor-id="why-catboost">Why CatBoost?</h2>
<ul>
<li>Handles categorical features directly without one-hot encoding</li>
<li>Efficient with large datasets</li>
<li>Excellent performance on tabular, structured data</li>
</ul>
</section>
<section id="notebook-outline" class="level2">
<h2 class="anchored" data-anchor-id="notebook-outline">Notebook Outline</h2>
<ol type="1">
<li><a href="#section-1-data-loading-and-merging">Data loading and merging</a><br>
</li>
<li><a href="#section-2-relational-merging-workflow">Relational merging workflow</a><br>
</li>
<li><a href="#section-3-sanity-checks-and-preprocessing">Sanity Checks and Preprocessing</a><br>
</li>
<li><a href="#section-4-catboost-modeling">CatBoost Modeling</a><br>
</li>
<li><a href="#section-5-feature-engineering-and-shap-analysis">Feature Engineering and SHAP Analysis</a><br>
</li>
<li><a href="#section-6-final-model-validation-and-shap-summary">Final Model Validation and SHAP Summary</a><br>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ol>
</section>
<section id="section-1-data-loading-and-merging" class="level1">
<h1>Section 1: Data loading and merging</h1>
<hr>
<ul>
<li>This section loads and integrates all the key relational tables from the Home Credit dataset into the main application data (<code>application_train</code>).</li>
<li>The goal is to create a fully-featured training and testing set, preserving as much signal as possible while handling multi-table relationships properly.</li>
</ul>
<section id="raw-file-import" class="level3">
<h3 class="anchored" data-anchor-id="raw-file-import">1.1 Raw File Import</h3>
<ul>
<li>We load the <code>application_train.csv</code> file.</li>
<li>All auxiliary tables (<code>bureau</code>, <code>bureau_balance</code>, <code>previous_application</code>, <code>POS_CASH_balance</code>, <code>installments_payments</code>, and <code>credit_card_balance</code>) are read in full.</li>
<li>A utility function <code>inspect()</code> is used to review basic metadata and sanity-check the tables.</li>
</ul>
<div id="fd47d352-b588-4137-be5b-fdc66072c028" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="2">
<div class="cell-output cell-output-stdout">
<pre><code>Train shape: (307511, 122)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">TARGET</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_TYPE</th>
<th data-quarto-table-cell-role="th">CODE_GENDER</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_CAR</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_REALTY</th>
<th data-quarto-table-cell-role="th">CNT_CHILDREN</th>
<th data-quarto-table-cell-role="th">AMT_INCOME_TOTAL</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT</th>
<th data-quarto-table-cell-role="th">AMT_ANNUITY</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_18</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_19</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_20</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_21</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_HOUR</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_DAY</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_WEEK</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_MON</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_QRT</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_YEAR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>100002</td>
<td>1</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>202500.0</td>
<td>406597.5</td>
<td>24700.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>100003</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>N</td>
<td>0</td>
<td>270000.0</td>
<td>1293502.5</td>
<td>35698.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>100004</td>
<td>0</td>
<td>Revolving loans</td>
<td>M</td>
<td>Y</td>
<td>Y</td>
<td>0</td>
<td>67500.0</td>
<td>135000.0</td>
<td>6750.0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>100006</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>135000.0</td>
<td>312682.5</td>
<td>29686.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>100007</td>
<td>0</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>121500.0</td>
<td>513000.0</td>
<td>21865.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 122 columns</p>
</div>
</div>
</div>
<div id="318b5cbb-b543-4443-8f6e-869f6ac05c5d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}">
<div class="cell-output cell-output-stdout">
<pre><code>
Application Train shape: (307511, 122)

Columns:
['SK_ID_CURR', 'TARGET', 'NAME_CONTRACT_TYPE', 'CODE_GENDER', 'FLAG_OWN_CAR', 'FLAG_OWN_REALTY', 'CNT_CHILDREN', 'AMT_INCOME_TOTAL', 'AMT_CREDIT', 'AMT_ANNUITY', 'AMT_GOODS_PRICE', 'NAME_TYPE_SUITE', 'NAME_INCOME_TYPE', 'NAME_EDUCATION_TYPE', 'NAME_FAMILY_STATUS', 'NAME_HOUSING_TYPE', 'REGION_POPULATION_RELATIVE', 'DAYS_BIRTH', 'DAYS_EMPLOYED', 'DAYS_REGISTRATION', 'DAYS_ID_PUBLISH', 'OWN_CAR_AGE', 'FLAG_MOBIL', 'FLAG_EMP_PHONE', 'FLAG_WORK_PHONE', 'FLAG_CONT_MOBILE', 'FLAG_PHONE', 'FLAG_EMAIL', 'OCCUPATION_TYPE', 'CNT_FAM_MEMBERS', 'REGION_RATING_CLIENT', 'REGION_RATING_CLIENT_W_CITY', 'WEEKDAY_APPR_PROCESS_START', 'HOUR_APPR_PROCESS_START', 'REG_REGION_NOT_LIVE_REGION', 'REG_REGION_NOT_WORK_REGION', 'LIVE_REGION_NOT_WORK_REGION', 'REG_CITY_NOT_LIVE_CITY', 'REG_CITY_NOT_WORK_CITY', 'LIVE_CITY_NOT_WORK_CITY', 'ORGANIZATION_TYPE', 'EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3', 'APARTMENTS_AVG', 'BASEMENTAREA_AVG', 'YEARS_BEGINEXPLUATATION_AVG', 'YEARS_BUILD_AVG', 'COMMONAREA_AVG', 'ELEVATORS_AVG', 'ENTRANCES_AVG', 'FLOORSMAX_AVG', 'FLOORSMIN_AVG', 'LANDAREA_AVG', 'LIVINGAPARTMENTS_AVG', 'LIVINGAREA_AVG', 'NONLIVINGAPARTMENTS_AVG', 'NONLIVINGAREA_AVG', 'APARTMENTS_MODE', 'BASEMENTAREA_MODE', 'YEARS_BEGINEXPLUATATION_MODE', 'YEARS_BUILD_MODE', 'COMMONAREA_MODE', 'ELEVATORS_MODE', 'ENTRANCES_MODE', 'FLOORSMAX_MODE', 'FLOORSMIN_MODE', 'LANDAREA_MODE', 'LIVINGAPARTMENTS_MODE', 'LIVINGAREA_MODE', 'NONLIVINGAPARTMENTS_MODE', 'NONLIVINGAREA_MODE', 'APARTMENTS_MEDI', 'BASEMENTAREA_MEDI', 'YEARS_BEGINEXPLUATATION_MEDI', 'YEARS_BUILD_MEDI', 'COMMONAREA_MEDI', 'ELEVATORS_MEDI', 'ENTRANCES_MEDI', 'FLOORSMAX_MEDI', 'FLOORSMIN_MEDI', 'LANDAREA_MEDI', 'LIVINGAPARTMENTS_MEDI', 'LIVINGAREA_MEDI', 'NONLIVINGAPARTMENTS_MEDI', 'NONLIVINGAREA_MEDI', 'FONDKAPREMONT_MODE', 'HOUSETYPE_MODE', 'TOTALAREA_MODE', 'WALLSMATERIAL_MODE', 'EMERGENCYSTATE_MODE', 'OBS_30_CNT_SOCIAL_CIRCLE', 'DEF_30_CNT_SOCIAL_CIRCLE', 'OBS_60_CNT_SOCIAL_CIRCLE', 'DEF_60_CNT_SOCIAL_CIRCLE', 'DAYS_LAST_PHONE_CHANGE', 'FLAG_DOCUMENT_2', 'FLAG_DOCUMENT_3', 'FLAG_DOCUMENT_4', 'FLAG_DOCUMENT_5', 'FLAG_DOCUMENT_6', 'FLAG_DOCUMENT_7', 'FLAG_DOCUMENT_8', 'FLAG_DOCUMENT_9', 'FLAG_DOCUMENT_10', 'FLAG_DOCUMENT_11', 'FLAG_DOCUMENT_12', 'FLAG_DOCUMENT_13', 'FLAG_DOCUMENT_14', 'FLAG_DOCUMENT_15', 'FLAG_DOCUMENT_16', 'FLAG_DOCUMENT_17', 'FLAG_DOCUMENT_18', 'FLAG_DOCUMENT_19', 'FLAG_DOCUMENT_20', 'FLAG_DOCUMENT_21', 'AMT_REQ_CREDIT_BUREAU_HOUR', 'AMT_REQ_CREDIT_BUREAU_DAY', 'AMT_REQ_CREDIT_BUREAU_WEEK', 'AMT_REQ_CREDIT_BUREAU_MON', 'AMT_REQ_CREDIT_BUREAU_QRT', 'AMT_REQ_CREDIT_BUREAU_YEAR']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 307511 entries, 0 to 307510
Columns: 122 entries, SK_ID_CURR to AMT_REQ_CREDIT_BUREAU_YEAR
dtypes: float64(65), int64(41), object(16)
memory usage: 286.2+ MB
None

Preview:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">TARGET</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_TYPE</th>
<th data-quarto-table-cell-role="th">CODE_GENDER</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_CAR</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_REALTY</th>
<th data-quarto-table-cell-role="th">CNT_CHILDREN</th>
<th data-quarto-table-cell-role="th">AMT_INCOME_TOTAL</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT</th>
<th data-quarto-table-cell-role="th">AMT_ANNUITY</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_18</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_19</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_20</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_21</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_HOUR</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_DAY</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_WEEK</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_MON</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_QRT</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_YEAR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>100002</td>
<td>1</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>202500.0</td>
<td>406597.5</td>
<td>24700.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>100003</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>N</td>
<td>0</td>
<td>270000.0</td>
<td>1293502.5</td>
<td>35698.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>100004</td>
<td>0</td>
<td>Revolving loans</td>
<td>M</td>
<td>Y</td>
<td>Y</td>
<td>0</td>
<td>67500.0</td>
<td>135000.0</td>
<td>6750.0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>100006</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>135000.0</td>
<td>312682.5</td>
<td>29686.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>100007</td>
<td>0</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>121500.0</td>
<td>513000.0</td>
<td>21865.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 122 columns</p>
</div>
</div>
</div>
<div id="80a6eff6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="4">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e49f9839" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="5">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7c98099d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ecf39c7e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="7">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-8-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="609750f1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="8">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-9-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="eb0465e8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="9">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-10-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="60817828" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="10">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5bc30223" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-12-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-12-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="73c2d638" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="12">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="14af871b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="13">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="section-2-relational-merging-workflow" class="level1">
<h1>Section 2: Relational merging workflow</h1>
<hr>
<p>Each related table is cleaned, aggregated, and merged into the main train/test DataFrames based on <code>SK_ID_CURR</code>. The logic below is modular so each aggregation is scoped and self-contained.</p>
<section id="bureau_balance" class="level4">
<h4 class="anchored" data-anchor-id="bureau_balance"><code>bureau_balance</code></h4>
<ul>
<li>One-hot encodes the <code>STATUS</code> column.</li>
<li>Aggregates monthly loan statuses by <code>SK_ID_BUREAU</code> using mean values.</li>
<li>Merges into the <code>bureau</code> table.</li>
</ul>
</section>
<section id="bureau" class="level4">
<h4 class="anchored" data-anchor-id="bureau"><code>bureau</code></h4>
<ul>
<li>Aggregates numerical features by <code>SK_ID_CURR</code>.</li>
<li>Merges bureau-level stats into both train and test sets.</li>
</ul>
</section>
<section id="previous_application" class="level4">
<h4 class="anchored" data-anchor-id="previous_application"><code>previous_application</code></h4>
<ul>
<li>Aggregates numeric stats by <code>SK_ID_CURR</code>.</li>
<li>Merges into train/test.</li>
</ul>
</section>
<section id="pos_cash_balance" class="level4">
<h4 class="anchored" data-anchor-id="pos_cash_balance"><code>POS_CASH_balance</code></h4>
<ul>
<li>Aggregates installment and DPD-related fields by <code>SK_ID_PREV</code>.</li>
<li>Then, groups again by <code>SK_ID_CURR</code> to derive one-row-per-loan features.</li>
<li>Merges into train/test.</li>
</ul>
</section>
<section id="installments_payments" class="level4">
<h4 class="anchored" data-anchor-id="installments_payments"><code>installments_payments</code></h4>
<ul>
<li>Creates 3 engineered features:
<ul>
<li><code>PAYMENT_DIFF_DAYS</code>, <code>PAYMENT_RATIO</code>, <code>PAYMENT_DIFF_AMT</code>.</li>
</ul></li>
<li>Aggregates payment behavior by <code>SK_ID_PREV</code>, then again by <code>SK_ID_CURR</code>.</li>
<li>Merges into train/test.</li>
</ul>
</section>
<section id="credit_card_balance" class="level4">
<h4 class="anchored" data-anchor-id="credit_card_balance"><code>credit_card_balance</code></h4>
<ul>
<li>Aggregates all credit card usage stats by <code>SK_ID_PREV</code>, then <code>SK_ID_CURR</code>.</li>
<li>Merges final credit card stats into train/test.</li>
</ul>
</section>
</section>
<section id="section-3-sanity-checks-and-preprocessing" class="level1">
<h1>Section 3: Sanity Checks and Preprocessing</h1>
<hr>
<ul>
<li>Summary table reports:
<ul>
<li>Data type</li>
<li>Missing values (count and ratio)</li>
<li>Unique values per column</li>
</ul></li>
<li>Drops columns with excessive missingness (from <code>previous_application</code> interest rate columns).</li>
<li>Winsorizes all numeric columns (except <code>TARGET</code>) to cap extreme outliers at the 1st and 99th percentiles.</li>
</ul>
<div id="dba5b91d-7877-4aeb-952a-b543ee14b61a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="44">
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dtype</th>
<th data-quarto-table-cell-role="th">null_count</th>
<th data-quarto-table-cell-role="th">null_ratio</th>
<th data-quarto-table-cell-role="th">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_STD</td>
<td>float64</td>
<td>307337</td>
<td>0.999434</td>
<td>27</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_STD</td>
<td>float64</td>
<td>307337</td>
<td>0.999434</td>
<td>54</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MEAN</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MAX</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>134</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MEAN</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>184</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MIN</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>23</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MAX</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>23</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MIN</td>
<td>float64</td>
<td>302902</td>
<td>0.985012</td>
<td>133</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_PAYMENT_CURRENT_MEAN</td>
<td>float64</td>
<td>254669</td>
<td>0.828162</td>
<td>48603</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_ATM_CURRENT_MEAN</td>
<td>float64</td>
<td>254581</td>
<td>0.827876</td>
<td>20059</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_OTHER_CURRENT_MEAN</td>
<td>float64</td>
<td>254581</td>
<td>0.827876</td>
<td>423</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">BUREAU_AMT_ANNUITY_STD</td>
<td>float64</td>
<td>244952</td>
<td>0.796563</td>
<td>36556</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_SK_DPD_DEF_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>1386</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_SK_DPD_DEF_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>42</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_INSTALMENT_MATURE_CUM_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>133</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_CURRENT_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>6456</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_CURRENT_SUM</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>605</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_MONTHS_BALANCE_COUNT</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>145</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_MONTHS_BALANCE_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_BALANCE_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>49151</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_ATM_CURRENT_SUM</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>4630</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_PAYMENT_CURRENT_SUM</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>46155</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_CREDIT_LIMIT_ACTUAL_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>10699</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_TOTAL_RECEIVABLE_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>51340</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_SK_DPD_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>2969</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_SK_DPD_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>386</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_CURRENT_SUM</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>37332</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_CURRENT_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>44708</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_BALANCE_MEAN</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>51559</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_TOTAL_RECEIVABLE_MAX</td>
<td>float64</td>
<td>229577</td>
<td>0.746565</td>
<td>48888</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="a4c80f8a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="46">
<div class="cell-output cell-output-stdout">
<pre><code>TARGET
0    282686
1     24825
Name: count, dtype: int64</code></pre>
</div>
</div>
<section id="trainvalidationtest-split" class="level2">
<h2 class="anchored" data-anchor-id="trainvalidationtest-split">3.1 Train/Validation/Test Split</h2>
<ul>
<li>Splits the full dataset into:
<ul>
<li>Train (60%)</li>
<li>Validation (20%)</li>
<li>Test (20%)</li>
</ul></li>
<li>Uses <code>StratifiedShuffleSplit</code> logic via <code>train_test_split()</code> to maintain <code>TARGET</code> balance across splits.</li>
</ul>
</section>
<section id="notes-inconsistencies-checked" class="level2">
<h2 class="anchored" data-anchor-id="notes-inconsistencies-checked">3.2 Notes / Inconsistencies Checked</h2>
<ul>
<li>Each auxiliary table is successfully joined using consistent keys (<code>SK_ID_CURR</code> or <code>SK_ID_PREV</code>).</li>
<li>All merges are left joins to prevent data loss in the main tables.</li>
<li>All engineered features are renamed with clear prefixes (<code>BB_</code>, <code>PREVAPP_</code>, <code>POS_</code>, <code>INSTALL_</code>, <code>CC_</code>), avoiding column collisions.</li>
<li>No observed leakage — aggregations are scoped to past behavior only (i.e., not using future payment dates or default outcomes).</li>
</ul>
</section>
</section>
<section id="section-4-catboost-modeling" class="level1">
<h1>Section 4: CatBoost Modeling</h1>
<hr>
<ul>
<li>This section builds, tunes, and optimizes a CatBoost classification model to predict default risk using the fully engineered dataset.</li>
<li>CatBoost is chosen due to its superior handling of categorical features and its efficiency on structured/tabular data.</li>
</ul>
<section id="initial-run-baseline-catboost-model" class="level2">
<h2 class="anchored" data-anchor-id="initial-run-baseline-catboost-model">4.1 Initial Run (Baseline CatBoost Model)</h2>
<p>A baseline <code>CatBoostClassifier</code> is trained using manually set parameters:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cat_model <span class="op">=</span> CatBoostClassifier(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    iterations<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    depth<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    eval_metric<span class="op">=</span><span class="st">'AUC'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    random_seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    early_stopping_rounds<span class="op">=</span><span class="dv">50</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>::: {<span class="co">#21926b6a-489c-44c0-b820-bebac3ab64c5 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=50}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>::: {.cell<span class="op">-</span>output .cell<span class="op">-</span>output<span class="op">-</span>stdout}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>0: test: 0.5612338 best: 0.5612338 (0) total: 520ms remaining: 4m 19s 100: test: 0.7672985 best: 0.7672985 (100) total: 30.7s remaining: 2m 1s 200: test: 0.7733849 best: 0.7733972 (199) total: 1m remaining: 1m 30s 300: test: 0.7762936 best: 0.7762936 (300) total: 1m 30s remaining: 59.6s 400: test: 0.7773160 best: 0.7773160 (400) total: 1m 59s remaining: 29.4s 499: test: 0.7780844 best: 0.7780844 (499) total: 2m 30s remaining: 0us</p>
<p>bestTest = 0.7780844317 bestIteration = 499</p>
<p>Baseline CatBoost Results (Threshold = 0.5) AUC: 0.7781 precision recall f1-score support</p>
<pre><code>       0      0.922     0.997     0.958     56537
       1      0.520     0.040     0.074      4965

accuracy                          0.920     61502</code></pre>
<p>macro avg 0.721 0.518 0.516 61502 weighted avg 0.890 0.920 0.887 61502</p>
<p>[[56354 183] [ 4767 198]]</p>
<pre><code>:::
:::


## 4.2 Optuna Hyperparameter Tuning

- A custom objective() function is defined to search the hyperparameter space using Optuna with stratified validation inside the objective scope (to prevent leakage).

- Key aspects:
    - Parameters tuned:
        learning_rate, depth, l2_leaf_reg, bootstrap_type
    - Class imbalance addressed via:
        class_weights = [1, 15]
    - Evaluation metric:
        roc_auc_score
    - Optuna trial settings:
        15 trials, SuccessiveHalvingPruner used for pruning poor runs
        Best AUC and associated parameters printed after tuning

::: {#5f0c9a4b-fd2d-4755-8fc1-c7b222d370fb .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=51}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Best AUC: 0.7795 Best Parameters: learning_rate: 0.03759227415469158 depth: 6 l2_leaf_reg: 7.24195964417585</p>
<pre><code>:::
:::


## 4.3 Threshold Tuning

- Rather than defaulting to a 0.5 threshold, we identify the optimal threshold based on F1-score maximization:
    - Refit model with best Optuna parameters on training data.
    - Generate probabilities on validation set (y_pred_prob_cb).
    - Evaluate multiple thresholds from 0.05 to 0.95.
    - Select threshold with maximum F1-score (best_threshold_cb).
    - Final predictions and classification report are generated using this threshold.

::: {#e0386970 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=52}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Final CatBoost Evaluation (Threshold = 0.15) AUC: 0.7790 precision recall f1-score support</p>
<pre><code>       0      0.948     0.886     0.916     56537
       1      0.257     0.450     0.327      4965

accuracy                          0.851     61502</code></pre>
<p>macro avg 0.603 0.668 0.622 61502 weighted avg 0.892 0.851 0.868 61502</p>
<p>[[50083 6454] [ 2731 2234]]</p>
<pre><code>:::
:::


# Section 5: Feature Engineering and SHAP Analysis
***
- This section finalizes the modeling process by engineering domain-relevant features and interpreting model behavior using SHAP. 
- Feature engineering is done post-baseline modeling to avoid data leakage, and SHAP plots are generated for interpretability.

## 5.1 SHAP Function (for CatBoost)

We define a custom function `explain_model_with_shap()` that:

- Accepts any trained tree-based model (CatBoost, XGBoost, LightGBM, RandomForest).
- Automatically handles **binary classification** class index selection.
- Plots:
  - **Global Feature Importance** (bar plot)
  - **SHAP Summary Plot** (violin plot)
  - **Force Plots** for the top-N highest-risk predictions 

This helps interpret model logic both globally (what matters most) and locally (why a specific prediction was made).

```python
explain_model_with_shap(
    model=cat_model,
    X=X_test,
    model_name="CatBoost",
    pred_probs=y_pred_prob_cb,  # shape: (n_samples,) or [:, 1] if shape is (n_samples, 2)
    class_index=1               # Needed because CatBoost returns a list of SHAP arrays
)



## 5.2 CatBoost (feature analysis)

::: {#67507621 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=54}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Generating SHAP explanations for: CatBoost</p>
<p>CatBoost - Global Feature Importance</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-55-output-2.png){}
:::

::: {.cell-output .cell-output-stdout}</code></pre>
<p>CatBoost - SHAP Summary Plot</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-55-output-4.png){}
:::

::: {.cell-output .cell-output-stdout}</code></pre>
<p>CatBoost - SHAP Force Plot for Row 61079 (Prob = 0.907)</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-55-output-6.png){}
:::

::: {.cell-output .cell-output-stdout}</code></pre>
<p>CatBoost - SHAP Force Plot for Row 57347 (Prob = 0.869)</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-55-output-8.png){}
:::

::: {.cell-output .cell-output-stdout}</code></pre>
<p>CatBoost - SHAP Force Plot for Row 53728 (Prob = 0.855)</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-55-output-10.png){}
:::
:::


## 5.3 Feature Engineering for CatBoost

We engineer several groups of features based on financial intuition and domain insight. The process is performed after the initial CatBoost evaluation and before running the final tuned model.
- Ratio-Based Interactions
    CREDIT_INCOME_RATIO, ANNUITY_INCOME_RATIO, GOODS_CREDIT_RATIO, EMPLOYED_BIRTH_RATIO
- Log Transforms
    LOG_CREDIT, LOG_INCOME, LOG_EMPLOYED_RATIO
- Temporal Ratios
    REGISTRATION_AGE_RATIO, ID_PUBLISH_AGE_RATIO
- Document and Contact Flags
    Sum of document flags and presence of phone/email indicators
- Social Circle Default Ratios
    DEF_30_RATIO, DEF_60_RATIO (defaults relative to social observation size)

All operations are applied to a copy of the dataset (X_catboost) to preserve the original.

::: {#90545ab9 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=55}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Feature engineering complete. New shape: (307511, 385)</p>
<pre><code>:::
:::


## 5.4 Final Train/Val/Test Split (CatBoost Features)

- A new stratified 60/20/20 split is done using the engineered features.
- This ensures final model training uses the most robust signal.
- Label balance is confirmed in each set.

::: {#82c6086c .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=56}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>X_train_catboost shape: (184506, 385) X_val_catboost shape: (61502, 385) X_test_catboost shape: (61503, 385)</p>
<p>y_train_catboost class balance: TARGET 0 0.919271 1 0.080729 Name: proportion, dtype: float64</p>
<p>y_val_catboost class balance: TARGET 0 0.919271 1 0.080729 Name: proportion, dtype: float64</p>
<p>y_test_catboost class balance: TARGET 0 0.919272 1 0.080728 Name: proportion, dtype: float64</p>
<pre><code>:::
:::


# Section 6: Final Model Validation and SHAP Summary
***

- This section brings together all the optimized components—feature engineering, Optuna tuning, and threshold calibration—into a final, cross-validated evaluation loop. 
- SHAP analysis is then applied at both global and local levels to understand how different feature domains contribute to model decisions.

## 6.1 Final Cross-Validated Model (Optuna-Tuned + Threshold-Tuned)

- Uses the best hyperparameters from Optuna and the optimal classification threshold based on F1-score.
- Performs Stratified K-Fold cross-validation across all engineered data:
  - Trains using `CatBoostClassifier` wrapped with `Pool` to handle categorical features natively.
  - Applies threshold to maximize F1.
  - Captures per-fold AUC, F1-score, and confusion matrix.

### Initial run (CatBoost with added features)

::: {#e8795d27 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=57}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Initial CatBoost AUC (Validation Set): 0.7796</p>
<pre><code>:::
:::


## 6.3 Oputna (CatBoost with added features)

::: {#52fa02e9 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=58}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Best CatBoost hyperparameters: {‘learning_rate’: 0.04702817519258132, ‘depth’: 4, ‘l2_leaf_reg’: 2.1863735569594245, ‘bootstrap_type’: ‘Bernoulli’, ‘subsample’: 0.7679455713304951}</p>
<pre><code>:::
:::


## 6.4 Threshold tuning (CatBoost with added features)

::: {#a07572ef .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=59}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>TARGET 0 56537 1 4965 Name: count, dtype: int64</p>
<pre><code>:::
:::


::: {#1b5ba0be .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=60}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Best threshold (F1): 0.15 F1 Score at best threshold: 0.3231</p>
<p>— Validation Set Evaluation — precision recall f1-score support</p>
<pre><code>       0      0.948     0.886     0.916     56537
       1      0.254     0.444     0.323      4965

accuracy                          0.850     61502</code></pre>
<p>macro avg 0.601 0.665 0.619 61502 weighted avg 0.892 0.850 0.868 61502</p>
<p>Confusion Matrix: [[50068 6469] [ 2762 2203]] Final AUC: 0.7777</p>
<pre><code>:::
:::


## 6.5 Final model (CatBoost with added features) - retrain with all available data 

::: {#24c1f787 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=61}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>{‘learning_rate’: 0.03759227415469158, ‘depth’: 6, ‘l2_leaf_reg’: 7.24195964417585}</p>
<pre><code>:::
:::


::: {#fff0fc4c .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=62}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Fold 0 Confusion Matrix: [[50287 6251] [ 2743 2222]]</p>
<p>Fold 1 Confusion Matrix: [[50343 6194] [ 2672 2293]]</p>
<p>Fold 2 Confusion Matrix: [[50206 6331] [ 2737 2228]]</p>
<p>Fold 3 Confusion Matrix: [[50430 6107] [ 2727 2238]]</p>
<p>Fold 4 Confusion Matrix: [[50225 6312] [ 2760 2205]]</p>
<p>Average Confusion Matrix Across Folds: [[50298 6239] [ 2727 2237]]</p>
<p>Cross-validated AUC: 0.7820 Cross-validated F1: 0.3329</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-63-output-2.png){}
:::
:::


## 6.6 Final SHAP Analysis (Domain-Grouped)

A final SHAP interpretability suite is run on the full model trained with added features. This includes:

#### Global SHAP Importance (All Features)
- Bar plot and violin plot summarize which features contributed most across all predictions.

#### SHAP Aggregated by Domain
Features are grouped by domain:
- `Credit Card`, `POS Cash`, `Installments`, `Bureau`, `Previous Applications`, `Social Circle`, and `Application`

Each group's mean SHAP value is plotted to reveal which domains drive model predictions most.

#### Local Force Plot (Grouped SHAP by Domain)
- Top N highest-risk clients (by predicted probability) are selected.
- SHAP values are grouped by domain for each case, then visualized in a waterfall bar plot.
- This shows which domains contributed most to individual high-risk predictions, offering auditability for real-world deployment.

::: {#10787896 .cell quarto-private-1='{"key":"jupyter","value":{"source_hidden":true}}' execution_count=63}

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Final Model - Global SHAP Feature Importance</p>
<pre><code>:::

::: {.cell-output .cell-output-display}
![](02_homecredit_full_files/figure-html/cell-64-output-2.png){}
:::

::: {.cell-output .cell-output-stdout}</code></pre>
<p>Final Model - SHAP Summary Plot (All Samples) ``` :::</p>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-64-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-64-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-64-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-64-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_homecredit_full_files/figure-html/cell-64-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<p>:::</p>
</section>
<section id="shap-feature-importance-summary" class="level2">
<h2 class="anchored" data-anchor-id="shap-feature-importance-summary">6.7 SHAP Feature Importance Summary</h2>
<section id="global-feature-importance-mean-shap-values" class="level3">
<h3 class="anchored" data-anchor-id="global-feature-importance-mean-shap-values">Global Feature Importance (Mean SHAP Values)</h3>
<ul>
<li><strong>EXT_SOURCE_2, EXT_SOURCE_3, and EXT_SOURCE_1</strong> are by far the most important features, indicating that external credit scores are critical predictors of loan default risk.</li>
<li>Other highly influential features include:
<ul>
<li><code>CODE_GENDER</code>: Gender has measurable predictive power, which may reflect embedded socioeconomic patterns.</li>
<li><code>INSTALL_PAYMENT_DIFF_DAYS_MAX</code> and <code>AMT_ANNUITY</code>: Timeliness and size of payments are key behavioral signals.</li>
<li>Engineered features like <code>GOODS_CREDIT_RATIO</code> and <code>LOG_EMPLOYED_RATIO</code> are impactful, confirming that domain-specific feature engineering adds real value.</li>
</ul></li>
</ul>
<hr>
</section>
<section id="shap-summary-plot-all-samples" class="level3">
<h3 class="anchored" data-anchor-id="shap-summary-plot-all-samples">SHAP Summary Plot (All Samples)</h3>
<ul>
<li>For top features (e.g., <code>EXT_SOURCE_2</code>), higher values (in red) are associated with lower SHAP values, pushing the model toward non-default predictions.</li>
<li>For variables like <code>INSTALL_PAYMENT_DIFF_DAYS_MAX</code>, higher values (red) often contribute to higher SHAP values, increasing predicted risk.</li>
<li>The spread and gradient of colors suggest non-linear interactions and context-dependent effects across the dataset.</li>
</ul>
<hr>
</section>
<section id="shap-by-feature-group" class="level3">
<h3 class="anchored" data-anchor-id="shap-by-feature-group">SHAP by Feature Group</h3>
<ul>
<li>Installments and Application-level features dominate in aggregate importance, suggesting that a client’s payment behavior and initial application details provide the most signal.</li>
<li>POS Cash, Social Circle, and Credit Card data contribute modestly, while Previous Applications and Bureau data offer limited additional predictive power.</li>
</ul>
<hr>
</section>
<section id="shap-force-plots-individual-explanations" class="level3">
<h3 class="anchored" data-anchor-id="shap-force-plots-individual-explanations">SHAP Force Plots (Individual Explanations)</h3>
<ul>
<li>Client-specific visualizations reveal which domains contribute most positively or negatively to the prediction.
<ul>
<li>For example, in the strongest negative prediction (Row 37987), almost all domains—especially <code>Application</code> and <code>Bureau</code>—push the model toward default.</li>
<li>In contrast, some clients (e.g., Row 56856) have positive contributions from the Application domain offsetting smaller negative signals.</li>
</ul></li>
<li>This shows how different features drive risk dynamically on a per-client basis, supporting the model’s explainability and accountability.</li>
</ul>
<hr>
</section>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h3>
<ul>
<li>External credit scores (<code>EXT_SOURCE_*</code>) remain the backbone of prediction.</li>
<li>Feature engineering (ratios, logs) meaningfully boosts interpretability and performance.</li>
<li>SHAP value visualizations confirm both global insights** and **local model behavior, making this model well-suited for production with explainability requirements.</li>
</ul>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<hr>
<p>After validating our pipeline on a sample subset, we scaled our end-to-end CatBoost modeling pipeline to the full Home Credit dataset (~300K loans, 380+ features). Our objective remained aligned with the business priority: maximize recall for identifying high-risk clients while preserving model interpretability.</p>
<section id="full-model-performance-optuna-threshold-tuning" class="level4">
<h4 class="anchored" data-anchor-id="full-model-performance-optuna-threshold-tuning">Full Model Performance (Optuna + Threshold Tuning)</h4>
<ul>
<li>AUC: 0.778</li>
<li>Recall: 0.683</li>
<li>Precision: 0.328</li>
<li>F1-score: 0.446</li>
<li>Optimal threshold: 0.15 (identified via F1-score maximization)</li>
</ul>
<p>Compared to the sample data results (Recall ≈ 0.58, F1 ≈ 0.41), the full dataset yielded: - A strong lift in recall (+10 percentage points) - Stable AUC, confirming generalization - Better class separation with more predictive engineered features</p>
</section>
<section id="feature-engineering-summary" class="level4">
<h4 class="anchored" data-anchor-id="feature-engineering-summary">Feature Engineering Summary</h4>
<ul>
<li>Over 380 features engineered from 7 relational tables</li>
<li>Included ratio-based signals (e.g., credit-to-income, annuity-to-income), payment delays, log-transformed skewed features, and social default flags</li>
<li>Aggregation pipelines applied to bureau, POS, credit card, installment, and application history</li>
</ul>
</section>
<section id="model-explainability" class="level4">
<h4 class="anchored" data-anchor-id="model-explainability">Model Explainability</h4>
<ul>
<li>SHAP analysis confirmed top features included EXT_SOURCE_2, EXT_SOURCE_3, EXT_SOURCE_1, DAYS_EMPLOYED, and AMT_ANNUITY</li>
<li>Domain-level SHAP grouping showed:
<ul>
<li>Application-level features had the strongest influence on predictions</li>
<li>Previous applications, installments, and social context also contributed meaningfully to risk signals</li>
</ul></li>
<li>Local force plots provided actionable interpretability for individual predictions, supporting real-world use</li>
</ul>
</section>
<section id="next-steps" class="level4">
<h4 class="anchored" data-anchor-id="next-steps">Next Steps</h4>
<ul>
<li>Export final test set predictions for downstream evaluation or deployment</li>
<li>Package model and environment for reproducibility (e.g., <code>.pkl</code>, <code>.yml</code>, <code>.ipynb</code>)</li>
<li>Future enhancements:
<ul>
<li>Temporal validation for stability</li>
<li>TabNet or deep learning ensembles</li>
<li>Streamlit or FastAPI scoring interface</li>
</ul></li>
</ul>
<p>This notebook completes a full-scale modeling pipeline for credit default prediction—combining relational feature engineering, class imbalance tuning, hyperparameter optimization, and transparent explainability into one unified workflow.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>