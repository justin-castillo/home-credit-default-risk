<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Home Credit Default Risk Analysis (Sampled Data)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="01_homecredit_sample_files/libs/clipboard/clipboard.min.js"></script>
<script src="01_homecredit_sample_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="01_homecredit_sample_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="01_homecredit_sample_files/libs/quarto-html/popper.min.js"></script>
<script src="01_homecredit_sample_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="01_homecredit_sample_files/libs/quarto-html/anchor.min.js"></script>
<link href="01_homecredit_sample_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="01_homecredit_sample_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="01_homecredit_sample_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="01_homecredit_sample_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="01_homecredit_sample_files/libs/bootstrap/bootstrap-bb202692a8aa56000c7e3728d06ff114.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#objective" id="toc-objective" class="nav-link active" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">Dataset</a></li>
  <li><a href="#models-tested" id="toc-models-tested" class="nav-link" data-scroll-target="#models-tested">Models tested</a></li>
  <li><a href="#evaluation-metric" id="toc-evaluation-metric" class="nav-link" data-scroll-target="#evaluation-metric">Evaluation metric</a></li>
  <li><a href="#notebook-outline" id="toc-notebook-outline" class="nav-link" data-scroll-target="#notebook-outline">Notebook Outline</a></li>
  <li><a href="#section-1-load-and-sample-datasets" id="toc-section-1-load-and-sample-datasets" class="nav-link" data-scroll-target="#section-1-load-and-sample-datasets">Section 1: Load and sample datasets</a>
  <ul class="collapse">
  <li><a href="#import-statements" id="toc-import-statements" class="nav-link" data-scroll-target="#import-statements">1.1 Import statements</a></li>
  <li><a href="#load-and-sample-datasets" id="toc-load-and-sample-datasets" class="nav-link" data-scroll-target="#load-and-sample-datasets">1.2 Load and sample datasets</a>
  <ul class="collapse">
  <li><a href="#data-integration" id="toc-data-integration" class="nav-link" data-scroll-target="#data-integration">Data Integration</a></li>
  <li><a href="#sampling-strategy" id="toc-sampling-strategy" class="nav-link" data-scroll-target="#sampling-strategy">Sampling strategy</a></li>
  </ul></li>
  <li><a href="#initial-load-of-main-table" id="toc-initial-load-of-main-table" class="nav-link" data-scroll-target="#initial-load-of-main-table">1.2 Initial load of main table</a></li>
  <li><a href="#sample-of-application_train.csv" id="toc-sample-of-application_train.csv" class="nav-link" data-scroll-target="#sample-of-application_train.csv">1.3 Sample of <code>application_train.csv</code></a></li>
  <li><a href="#sample-of-bureau.csv" id="toc-sample-of-bureau.csv" class="nav-link" data-scroll-target="#sample-of-bureau.csv">1.4 Sample of <code>bureau.csv</code></a></li>
  <li><a href="#sample-of-bureau_balance.csv" id="toc-sample-of-bureau_balance.csv" class="nav-link" data-scroll-target="#sample-of-bureau_balance.csv">1.5 Sample of <code>bureau_balance.csv</code></a></li>
  <li><a href="#sample-of-previous_application.csv" id="toc-sample-of-previous_application.csv" class="nav-link" data-scroll-target="#sample-of-previous_application.csv">1.6 Sample of <code>previous_application.csv</code></a></li>
  <li><a href="#sample-of-pos_cash_balance.csv" id="toc-sample-of-pos_cash_balance.csv" class="nav-link" data-scroll-target="#sample-of-pos_cash_balance.csv">1.7 Sample of <code>POS_cash_balance.csv</code></a></li>
  <li><a href="#sample-of-installments_payments.csv" id="toc-sample-of-installments_payments.csv" class="nav-link" data-scroll-target="#sample-of-installments_payments.csv">1.8 Sample of <code>installments_payments.csv</code></a></li>
  <li><a href="#sample-of-credit_card_balance.csv" id="toc-sample-of-credit_card_balance.csv" class="nav-link" data-scroll-target="#sample-of-credit_card_balance.csv">1.9 Sample of <code>credit_card_balance.csv</code></a></li>
  </ul></li>
  <li><a href="#section-2-encode-aggregate-and-merge" id="toc-section-2-encode-aggregate-and-merge" class="nav-link" data-scroll-target="#section-2-encode-aggregate-and-merge">Section 2: Encode, aggregate, and merge</a>
  <ul class="collapse">
  <li><a href="#load-samples" id="toc-load-samples" class="nav-link" data-scroll-target="#load-samples">2.1 Load samples</a></li>
  <li><a href="#encode-and-aggregate-bureau_bal_sample" id="toc-encode-and-aggregate-bureau_bal_sample" class="nav-link" data-scroll-target="#encode-and-aggregate-bureau_bal_sample">2.2 Encode and aggregate <code>bureau_bal_sample</code></a></li>
  <li><a href="#merge-bureau_bal_sample-with-bureau_sample-into-bureau_merged" id="toc-merge-bureau_bal_sample-with-bureau_sample-into-bureau_merged" class="nav-link" data-scroll-target="#merge-bureau_bal_sample-with-bureau_sample-into-bureau_merged">2.3 Merge <code>bureau_bal_sample</code> with <code>bureau_sample</code> into <code>bureau_merged</code></a></li>
  <li><a href="#encode-and-aggregate-bureau_merged-into-bureau_agg" id="toc-encode-and-aggregate-bureau_merged-into-bureau_agg" class="nav-link" data-scroll-target="#encode-and-aggregate-bureau_merged-into-bureau_agg">2.4 Encode and aggregate <code>bureau_merged</code> into <code>bureau_agg</code></a></li>
  <li><a href="#merge-bureau_agg-with-app_sample-into-app_with_bureau" id="toc-merge-bureau_agg-with-app_sample-into-app_with_bureau" class="nav-link" data-scroll-target="#merge-bureau_agg-with-app_sample-into-app_with_bureau">2.5 Merge <code>bureau_agg</code> with <code>app_sample</code> into <code>app_with_bureau</code></a></li>
  <li><a href="#load-and-encode-sample_previous_application" id="toc-load-and-encode-sample_previous_application" class="nav-link" data-scroll-target="#load-and-encode-sample_previous_application">2.6 Load and encode <code>sample_previous_application</code></a></li>
  <li><a href="#aggregate-numeric-columns-into-prev_agg" id="toc-aggregate-numeric-columns-into-prev_agg" class="nav-link" data-scroll-target="#aggregate-numeric-columns-into-prev_agg">2.7 Aggregate numeric columns into <code>prev_agg</code></a></li>
  <li><a href="#merge-sampled-previous_application-with-main-table-on-sk_id_curr" id="toc-merge-sampled-previous_application-with-main-table-on-sk_id_curr" class="nav-link" data-scroll-target="#merge-sampled-previous_application-with-main-table-on-sk_id_curr">2.8 Merge sampled <code>previous_application</code> with main table on <code>SK_ID_CURR</code></a></li>
  <li><a href="#load-sampled-pos_cash_balance" id="toc-load-sampled-pos_cash_balance" class="nav-link" data-scroll-target="#load-sampled-pos_cash_balance">2.9 Load sampled <code>POS_CASH_balance</code></a></li>
  <li><a href="#aggregate-numerical-features-from-sampled-pos_cash_balance" id="toc-aggregate-numerical-features-from-sampled-pos_cash_balance" class="nav-link" data-scroll-target="#aggregate-numerical-features-from-sampled-pos_cash_balance">2.10 Aggregate numerical features from sampled <code>POS_CASH_balance</code></a></li>
  <li><a href="#merge-sampled-and-aggregated-pos_cash_balance-with-sampled-previous_application-on-sk_id_prev" id="toc-merge-sampled-and-aggregated-pos_cash_balance-with-sampled-previous_application-on-sk_id_prev" class="nav-link" data-scroll-target="#merge-sampled-and-aggregated-pos_cash_balance-with-sampled-previous_application-on-sk_id_prev">2.11 Merge sampled and aggregated <code>POS_CASH_balance</code> with sampled <code>previous_application</code> on <code>SK_ID_PREV</code></a></li>
  <li><a href="#load-sampled-installments_payments" id="toc-load-sampled-installments_payments" class="nav-link" data-scroll-target="#load-sampled-installments_payments">2.12 Load sampled <code>installments_payments</code></a></li>
  <li><a href="#required-feature-engineering" id="toc-required-feature-engineering" class="nav-link" data-scroll-target="#required-feature-engineering">2.13 Required feature engineering</a></li>
  <li><a href="#load-sampled-credit_card_balance" id="toc-load-sampled-credit_card_balance" class="nav-link" data-scroll-target="#load-sampled-credit_card_balance">2.14 Load sampled <code>credit_card_balance</code></a></li>
  <li><a href="#aggregate-time-based-features-from-credit_card_balance-on-sk_id_prev-merge-with-previous_application-merge-with-main-table" id="toc-aggregate-time-based-features-from-credit_card_balance-on-sk_id_prev-merge-with-previous_application-merge-with-main-table" class="nav-link" data-scroll-target="#aggregate-time-based-features-from-credit_card_balance-on-sk_id_prev-merge-with-previous_application-merge-with-main-table">2.15 Aggregate time-based features from <code>credit_card_balance</code> on <code>SK_ID_PREV</code>, merge with <code>previous_application</code>, merge with main table</a></li>
  <li><a href="#final-sampled-table" id="toc-final-sampled-table" class="nav-link" data-scroll-target="#final-sampled-table">2.16 Final (sampled) table</a></li>
  </ul></li>
  <li><a href="#section-3-preprocessing" id="toc-section-3-preprocessing" class="nav-link" data-scroll-target="#section-3-preprocessing">Section 3: Preprocessing</a>
  <ul class="collapse">
  <li><a href="#initial-checks-and-cleanup" id="toc-initial-checks-and-cleanup" class="nav-link" data-scroll-target="#initial-checks-and-cleanup">3.1 Initial checks and cleanup</a></li>
  <li><a href="#drop-columns-with-nulls-95" id="toc-drop-columns-with-nulls-95" class="nav-link" data-scroll-target="#drop-columns-with-nulls-95">3.2 Drop columns with nulls &gt; 95%</a></li>
  <li><a href="#outlier-clipping" id="toc-outlier-clipping" class="nav-link" data-scroll-target="#outlier-clipping">3.3 Outlier clipping</a></li>
  <li><a href="#data-splits" id="toc-data-splits" class="nav-link" data-scroll-target="#data-splits">3.4 Data splits</a></li>
  <li><a href="#impute-nulls-with-zero-or-median" id="toc-impute-nulls-with-zero-or-median" class="nav-link" data-scroll-target="#impute-nulls-with-zero-or-median">3.5 Impute nulls with zero or median</a></li>
  <li><a href="#trainvaltest-splits" id="toc-trainvaltest-splits" class="nav-link" data-scroll-target="#trainvaltest-splits">3.6 Train/val/test splits</a></li>
  </ul></li>
  <li><a href="#section-4-modeling" id="toc-section-4-modeling" class="nav-link" data-scroll-target="#section-4-modeling">Section 4: Modeling</a>
  <ul class="collapse">
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression">4.1 Logistic Regression</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">4.2 Random Forest</a>
  <ul class="collapse">
  <li><a href="#initial-model-default-parameters" id="toc-initial-model-default-parameters" class="nav-link" data-scroll-target="#initial-model-default-parameters">Initial model (default parameters)</a></li>
  <li><a href="#hyperparameter-tuning-with-optuna" id="toc-hyperparameter-tuning-with-optuna" class="nav-link" data-scroll-target="#hyperparameter-tuning-with-optuna">Hyperparameter Tuning with Optuna</a></li>
  <li><a href="#retrain-and-threshold-tuning" id="toc-retrain-and-threshold-tuning" class="nav-link" data-scroll-target="#retrain-and-threshold-tuning">Retrain and Threshold Tuning</a></li>
  </ul></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost">4.3 XGBoost</a>
  <ul class="collapse">
  <li><a href="#initial-model-default-parameters-1" id="toc-initial-model-default-parameters-1" class="nav-link" data-scroll-target="#initial-model-default-parameters-1">Initial model (default parameters)</a></li>
  <li><a href="#hyperparameter-tuning-with-optuna-1" id="toc-hyperparameter-tuning-with-optuna-1" class="nav-link" data-scroll-target="#hyperparameter-tuning-with-optuna-1">Hyperparameter tuning with Optuna</a></li>
  <li><a href="#retrain-and-threshold-tuning-1" id="toc-retrain-and-threshold-tuning-1" class="nav-link" data-scroll-target="#retrain-and-threshold-tuning-1">Retrain and threshold tuning</a></li>
  </ul></li>
  <li><a href="#catboost" id="toc-catboost" class="nav-link" data-scroll-target="#catboost">4.4 CatBoost</a>
  <ul class="collapse">
  <li><a href="#initial-run" id="toc-initial-run" class="nav-link" data-scroll-target="#initial-run">Initial run</a></li>
  <li><a href="#optuna-tuning" id="toc-optuna-tuning" class="nav-link" data-scroll-target="#optuna-tuning">Optuna Tuning</a></li>
  <li><a href="#retrain-on-full-trainval-with-best-params" id="toc-retrain-on-full-trainval-with-best-params" class="nav-link" data-scroll-target="#retrain-on-full-trainval-with-best-params">Retrain on full train/val with best params</a></li>
  <li><a href="#threshold-tuning" id="toc-threshold-tuning" class="nav-link" data-scroll-target="#threshold-tuning">Threshold tuning</a></li>
  <li><a href="#final-evaluation" id="toc-final-evaluation" class="nav-link" data-scroll-target="#final-evaluation">Final evaluation</a></li>
  </ul></li>
  <li><a href="#lightgbm" id="toc-lightgbm" class="nav-link" data-scroll-target="#lightgbm">4.5 LightGBM</a>
  <ul class="collapse">
  <li><a href="#initial-run-1" id="toc-initial-run-1" class="nav-link" data-scroll-target="#initial-run-1">Initial run</a></li>
  <li><a href="#optuna-tuning-1" id="toc-optuna-tuning-1" class="nav-link" data-scroll-target="#optuna-tuning-1">Optuna Tuning</a></li>
  <li><a href="#threshold-tuning-1" id="toc-threshold-tuning-1" class="nav-link" data-scroll-target="#threshold-tuning-1">Threshold tuning</a></li>
  <li><a href="#final-evaluation-1" id="toc-final-evaluation-1" class="nav-link" data-scroll-target="#final-evaluation-1">Final evaluation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#section-5-model-selection" id="toc-section-5-model-selection" class="nav-link" data-scroll-target="#section-5-model-selection">Section 5: Model selection</a>
  <ul class="collapse">
  <li><a href="#summary-metrics" id="toc-summary-metrics" class="nav-link" data-scroll-target="#summary-metrics">5.1 Summary metrics</a></li>
  </ul></li>
  <li><a href="#section-6-feature-engineering" id="toc-section-6-feature-engineering" class="nav-link" data-scroll-target="#section-6-feature-engineering">Section 6: Feature engineering</a>
  <ul class="collapse">
  <li><a href="#feature-analysis" id="toc-feature-analysis" class="nav-link" data-scroll-target="#feature-analysis">6.1 Feature analysis</a>
  <ul class="collapse">
  <li><a href="#shap-function" id="toc-shap-function" class="nav-link" data-scroll-target="#shap-function">SHAP function</a></li>
  <li><a href="#feature-engineering-catboost" id="toc-feature-engineering-catboost" class="nav-link" data-scroll-target="#feature-engineering-catboost">Feature engineering (CatBoost)</a></li>
  <li><a href="#initial-run-catboost-with-added-features" id="toc-initial-run-catboost-with-added-features" class="nav-link" data-scroll-target="#initial-run-catboost-with-added-features">Initial run (CatBoost with added features)</a></li>
  <li><a href="#oputna-catboost-with-added-features" id="toc-oputna-catboost-with-added-features" class="nav-link" data-scroll-target="#oputna-catboost-with-added-features">Oputna (CatBoost with added features)</a></li>
  <li><a href="#threshold-tuning-catboost-with-added-features" id="toc-threshold-tuning-catboost-with-added-features" class="nav-link" data-scroll-target="#threshold-tuning-catboost-with-added-features">Threshold tuning (CatBoost with added features)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#section-7-final-model-catboost-with-added-features---retrain-with-all-available-data" id="toc-section-7-final-model-catboost-with-added-features---retrain-with-all-available-data" class="nav-link" data-scroll-target="#section-7-final-model-catboost-with-added-features---retrain-with-all-available-data">Section 7: Final model (CatBoost with added features) - retrain with all available data</a></li>
  <li><a href="#conclusion-and-next-steps" id="toc-conclusion-and-next-steps" class="nav-link" data-scroll-target="#conclusion-and-next-steps">Conclusion and Next Steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Home Credit Default Risk Analysis (Sampled Data)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<hr>
<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>This notebook develops a baseline model using a variety of models on a sampled subset of the Home Credit Default Risk dataset. The primary goal is to predict the likelihood that a loan applicant will experience payment difficulties, using historical credit, demographic, and behavioral features.</p>
</section>
<section id="dataset" class="level2">
<h2 class="anchored" data-anchor-id="dataset">Dataset</h2>
<p>This analysis uses a downsampled version of the original datasets for rapid iteration and model tuning. All preprocessing steps and model logic will mirror the full dataset pipeline with appropriate adaptions (included as a separate notebook), enabling easy transfer. All datasets are merged into one dataset on the loan / applicant level using the key <code>SKI_ID_CURR</code> (or <code>SK_ID_PREV</code>, which merges into datasets that have <code>SK_ID_CURR</code>, which then merge into one dataset.) All time-series features are aggregated to enable their usefulness.</p>
<ul>
<li>Each row: one loan application (‘SK_ID_CURR’)</li>
<li><code>TARGET = 1</code>: client had significant payment issues</li>
<li><code>TARGET = 0</code>: client repaid as expected</li>
</ul>
</section>
<section id="models-tested" class="level2">
<h2 class="anchored" data-anchor-id="models-tested">Models tested</h2>
<ul>
<li>Logistic Regression: used as a baseline to compare other, more complex models</li>
<li>Random Forest: captures nonlinear relationships and reduces overfitting through bagging</li>
<li>XGBoost: scalable gradient boosting method</li>
<li>CatBoost: optimized for handling categorical variables natively</li>
<li>LightGBM: fast and efficient with large datasets</li>
</ul>
<p>This dataset, comprised of several base tables, is very large, spanning millions of rows and hundreds of features. This necessitates using a model that can handle a large number of complex features to successfully complete a classification task.</p>
</section>
<section id="evaluation-metric" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-metric">Evaluation metric</h2>
<p>The primary metric is AUC_ROC, with secondary attention to Recall, due to the cost of missing high-risk clients. Threshold optimization will be explored.</p>
</section>
<section id="notebook-outline" class="level2">
<h2 class="anchored" data-anchor-id="notebook-outline">Notebook Outline</h2>
<ol type="1">
<li>Load and sample datasets</li>
<li>Encode, aggregate, and merge</li>
<li>Preprocessing</li>
<li>Modeling</li>
<li>Model selection</li>
<li>Feature engineering</li>
<li>Final model</li>
<li>Conclusion</li>
</ol>
</section>
<section id="section-1-load-and-sample-datasets" class="level1">
<h1>Section 1: Load and sample datasets</h1>
<hr>
<section id="import-statements" class="level2">
<h2 class="anchored" data-anchor-id="import-statements">1.1 Import statements</h2>
</section>
<section id="load-and-sample-datasets" class="level2">
<h2 class="anchored" data-anchor-id="load-and-sample-datasets">1.2 Load and sample datasets</h2>
<ul>
<li>To facilitate for efficient development and model testing, this notebook uses a sampled subset of of the full Home Credit Default Risk dataaset to assess techniques that will be applied to the original dataset in the next notebook.</li>
</ul>
<section id="data-integration" class="level3">
<h3 class="anchored" data-anchor-id="data-integration">Data Integration</h3>
<p>The main dataset is <code>application_train.csv</code>, which contains one row per loan application and the <code>TARGET</code> variable. To enrich this data, relational joins are made between several secondary tables using <code>SK_ID_CURR</code> or <code>SK_ID_PREV</code> as appropriate.</p>
<ul>
<li><code>bureau.csv</code> and <code>bureau_balance.csv</code>: previous credit hitory from other institutions</li>
<li><code>previous_application.csv</code>: prior loan applications with Home Credit</li>
<li><code>installments_payments.csv</code>: repayment history</li>
<li><code>credit_card_balance.csv</code>: monthly credit card activity</li>
<li><code>POS_CASH_balance.csv</code>: point-of-sale and cash loan snapshots</li>
</ul>
<p>For each auxiliary table: - We aggregate features by <code>SK_ID_CURR</code> using summary statistics (mean, max, std, count, sum). - This results in one row per loan in the final joined dataset while preserving alignment with the target variable.</p>
</section>
<section id="sampling-strategy" class="level3">
<h3 class="anchored" data-anchor-id="sampling-strategy">Sampling strategy</h3>
<ul>
<li>A sample taken, comprising of 10-20% of the original datasets, using stratification to maintain the original class imbalance and ensure that the minority class (<code>TARGET=1</code>) is properly represented.</li>
</ul>
</section>
</section>
<section id="initial-load-of-main-table" class="level2">
<h2 class="anchored" data-anchor-id="initial-load-of-main-table">1.2 Initial load of main table</h2>
<ul>
<li><code>application_train.csv</code> is what the other tables will eventually be merged into.</li>
<li>There are over 300k rows, and 121 features (minus the target variable) that will need consideration.</li>
</ul>
<div id="fd47d352-b588-4137-be5b-fdc66072c028" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="2">
<div class="cell-output cell-output-stdout">
<pre><code>
Application Train shape: (307511, 122)

Columns:
['SK_ID_CURR', 'TARGET', 'NAME_CONTRACT_TYPE', 'CODE_GENDER', 'FLAG_OWN_CAR', 'FLAG_OWN_REALTY', 'CNT_CHILDREN', 'AMT_INCOME_TOTAL', 'AMT_CREDIT', 'AMT_ANNUITY', 'AMT_GOODS_PRICE', 'NAME_TYPE_SUITE', 'NAME_INCOME_TYPE', 'NAME_EDUCATION_TYPE', 'NAME_FAMILY_STATUS', 'NAME_HOUSING_TYPE', 'REGION_POPULATION_RELATIVE', 'DAYS_BIRTH', 'DAYS_EMPLOYED', 'DAYS_REGISTRATION', 'DAYS_ID_PUBLISH', 'OWN_CAR_AGE', 'FLAG_MOBIL', 'FLAG_EMP_PHONE', 'FLAG_WORK_PHONE', 'FLAG_CONT_MOBILE', 'FLAG_PHONE', 'FLAG_EMAIL', 'OCCUPATION_TYPE', 'CNT_FAM_MEMBERS', 'REGION_RATING_CLIENT', 'REGION_RATING_CLIENT_W_CITY', 'WEEKDAY_APPR_PROCESS_START', 'HOUR_APPR_PROCESS_START', 'REG_REGION_NOT_LIVE_REGION', 'REG_REGION_NOT_WORK_REGION', 'LIVE_REGION_NOT_WORK_REGION', 'REG_CITY_NOT_LIVE_CITY', 'REG_CITY_NOT_WORK_CITY', 'LIVE_CITY_NOT_WORK_CITY', 'ORGANIZATION_TYPE', 'EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3', 'APARTMENTS_AVG', 'BASEMENTAREA_AVG', 'YEARS_BEGINEXPLUATATION_AVG', 'YEARS_BUILD_AVG', 'COMMONAREA_AVG', 'ELEVATORS_AVG', 'ENTRANCES_AVG', 'FLOORSMAX_AVG', 'FLOORSMIN_AVG', 'LANDAREA_AVG', 'LIVINGAPARTMENTS_AVG', 'LIVINGAREA_AVG', 'NONLIVINGAPARTMENTS_AVG', 'NONLIVINGAREA_AVG', 'APARTMENTS_MODE', 'BASEMENTAREA_MODE', 'YEARS_BEGINEXPLUATATION_MODE', 'YEARS_BUILD_MODE', 'COMMONAREA_MODE', 'ELEVATORS_MODE', 'ENTRANCES_MODE', 'FLOORSMAX_MODE', 'FLOORSMIN_MODE', 'LANDAREA_MODE', 'LIVINGAPARTMENTS_MODE', 'LIVINGAREA_MODE', 'NONLIVINGAPARTMENTS_MODE', 'NONLIVINGAREA_MODE', 'APARTMENTS_MEDI', 'BASEMENTAREA_MEDI', 'YEARS_BEGINEXPLUATATION_MEDI', 'YEARS_BUILD_MEDI', 'COMMONAREA_MEDI', 'ELEVATORS_MEDI', 'ENTRANCES_MEDI', 'FLOORSMAX_MEDI', 'FLOORSMIN_MEDI', 'LANDAREA_MEDI', 'LIVINGAPARTMENTS_MEDI', 'LIVINGAREA_MEDI', 'NONLIVINGAPARTMENTS_MEDI', 'NONLIVINGAREA_MEDI', 'FONDKAPREMONT_MODE', 'HOUSETYPE_MODE', 'TOTALAREA_MODE', 'WALLSMATERIAL_MODE', 'EMERGENCYSTATE_MODE', 'OBS_30_CNT_SOCIAL_CIRCLE', 'DEF_30_CNT_SOCIAL_CIRCLE', 'OBS_60_CNT_SOCIAL_CIRCLE', 'DEF_60_CNT_SOCIAL_CIRCLE', 'DAYS_LAST_PHONE_CHANGE', 'FLAG_DOCUMENT_2', 'FLAG_DOCUMENT_3', 'FLAG_DOCUMENT_4', 'FLAG_DOCUMENT_5', 'FLAG_DOCUMENT_6', 'FLAG_DOCUMENT_7', 'FLAG_DOCUMENT_8', 'FLAG_DOCUMENT_9', 'FLAG_DOCUMENT_10', 'FLAG_DOCUMENT_11', 'FLAG_DOCUMENT_12', 'FLAG_DOCUMENT_13', 'FLAG_DOCUMENT_14', 'FLAG_DOCUMENT_15', 'FLAG_DOCUMENT_16', 'FLAG_DOCUMENT_17', 'FLAG_DOCUMENT_18', 'FLAG_DOCUMENT_19', 'FLAG_DOCUMENT_20', 'FLAG_DOCUMENT_21', 'AMT_REQ_CREDIT_BUREAU_HOUR', 'AMT_REQ_CREDIT_BUREAU_DAY', 'AMT_REQ_CREDIT_BUREAU_WEEK', 'AMT_REQ_CREDIT_BUREAU_MON', 'AMT_REQ_CREDIT_BUREAU_QRT', 'AMT_REQ_CREDIT_BUREAU_YEAR']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 307511 entries, 0 to 307510
Columns: 122 entries, SK_ID_CURR to AMT_REQ_CREDIT_BUREAU_YEAR
dtypes: float64(65), int64(41), object(16)
memory usage: 286.2+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">TARGET</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_TYPE</th>
<th data-quarto-table-cell-role="th">CODE_GENDER</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_CAR</th>
<th data-quarto-table-cell-role="th">FLAG_OWN_REALTY</th>
<th data-quarto-table-cell-role="th">CNT_CHILDREN</th>
<th data-quarto-table-cell-role="th">AMT_INCOME_TOTAL</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT</th>
<th data-quarto-table-cell-role="th">AMT_ANNUITY</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_18</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_19</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_20</th>
<th data-quarto-table-cell-role="th">FLAG_DOCUMENT_21</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_HOUR</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_DAY</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_WEEK</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_MON</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_QRT</th>
<th data-quarto-table-cell-role="th">AMT_REQ_CREDIT_BUREAU_YEAR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>100002</td>
<td>1</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>202500.0</td>
<td>406597.5</td>
<td>24700.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>100003</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>N</td>
<td>0</td>
<td>270000.0</td>
<td>1293502.5</td>
<td>35698.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>100004</td>
<td>0</td>
<td>Revolving loans</td>
<td>M</td>
<td>Y</td>
<td>Y</td>
<td>0</td>
<td>67500.0</td>
<td>135000.0</td>
<td>6750.0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>100006</td>
<td>0</td>
<td>Cash loans</td>
<td>F</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>135000.0</td>
<td>312682.5</td>
<td>29686.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>100007</td>
<td>0</td>
<td>Cash loans</td>
<td>M</td>
<td>N</td>
<td>Y</td>
<td>0</td>
<td>121500.0</td>
<td>513000.0</td>
<td>21865.5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 122 columns</p>
</div>
</div>
</div>
</section>
<section id="sample-of-application_train.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-application_train.csv">1.3 Sample of <code>application_train.csv</code></h2>
<ul>
<li>10% of this data is sampled into <code>app_sample</code> and the sampled dataset is saved as a .csv file to enable merging.</li>
</ul>
</section>
<section id="sample-of-bureau.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-bureau.csv">1.4 Sample of <code>bureau.csv</code></h2>
<ul>
<li><code>bureau.csv</code> is filtered to keep only rows that have <code>SK_ID_CURR</code> in the sample set <code>bureau_sample</code>, which is saved to .csv.</li>
<li>Filtering this way ensures that only credit bureau records that pertain to applicants sampled in <code>application_train</code> will be included in the analysis.</li>
</ul>
<div id="08097241-9047-446a-bcd8-73759a1e07a1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="4">
<div class="cell-output cell-output-stdout">
<pre><code>
Bureau shape: (1716428, 17)

Columns:
['SK_ID_CURR', 'SK_ID_BUREAU', 'CREDIT_ACTIVE', 'CREDIT_CURRENCY', 'DAYS_CREDIT', 'CREDIT_DAY_OVERDUE', 'DAYS_CREDIT_ENDDATE', 'DAYS_ENDDATE_FACT', 'AMT_CREDIT_MAX_OVERDUE', 'CNT_CREDIT_PROLONG', 'AMT_CREDIT_SUM', 'AMT_CREDIT_SUM_DEBT', 'AMT_CREDIT_SUM_LIMIT', 'AMT_CREDIT_SUM_OVERDUE', 'CREDIT_TYPE', 'DAYS_CREDIT_UPDATE', 'AMT_ANNUITY']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1716428 entries, 0 to 1716427
Data columns (total 17 columns):
 #   Column                  Dtype  
---  ------                  -----  
 0   SK_ID_CURR              int64  
 1   SK_ID_BUREAU            int64  
 2   CREDIT_ACTIVE           object 
 3   CREDIT_CURRENCY         object 
 4   DAYS_CREDIT             int64  
 5   CREDIT_DAY_OVERDUE      int64  
 6   DAYS_CREDIT_ENDDATE     float64
 7   DAYS_ENDDATE_FACT       float64
 8   AMT_CREDIT_MAX_OVERDUE  float64
 9   CNT_CREDIT_PROLONG      int64  
 10  AMT_CREDIT_SUM          float64
 11  AMT_CREDIT_SUM_DEBT     float64
 12  AMT_CREDIT_SUM_LIMIT    float64
 13  AMT_CREDIT_SUM_OVERDUE  float64
 14  CREDIT_TYPE             object 
 15  DAYS_CREDIT_UPDATE      int64  
 16  AMT_ANNUITY             float64
dtypes: float64(8), int64(6), object(3)
memory usage: 222.6+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">SK_ID_BUREAU</th>
<th data-quarto-table-cell-role="th">CREDIT_ACTIVE</th>
<th data-quarto-table-cell-role="th">CREDIT_CURRENCY</th>
<th data-quarto-table-cell-role="th">DAYS_CREDIT</th>
<th data-quarto-table-cell-role="th">CREDIT_DAY_OVERDUE</th>
<th data-quarto-table-cell-role="th">DAYS_CREDIT_ENDDATE</th>
<th data-quarto-table-cell-role="th">DAYS_ENDDATE_FACT</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_MAX_OVERDUE</th>
<th data-quarto-table-cell-role="th">CNT_CREDIT_PROLONG</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_SUM</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_SUM_DEBT</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_SUM_LIMIT</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_SUM_OVERDUE</th>
<th data-quarto-table-cell-role="th">CREDIT_TYPE</th>
<th data-quarto-table-cell-role="th">DAYS_CREDIT_UPDATE</th>
<th data-quarto-table-cell-role="th">AMT_ANNUITY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>215354</td>
<td>5714462</td>
<td>Closed</td>
<td>currency 1</td>
<td>-497</td>
<td>0</td>
<td>-153.0</td>
<td>-153.0</td>
<td>NaN</td>
<td>0</td>
<td>91323.0</td>
<td>0.0</td>
<td>NaN</td>
<td>0.0</td>
<td>Consumer credit</td>
<td>-131</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>215354</td>
<td>5714463</td>
<td>Active</td>
<td>currency 1</td>
<td>-208</td>
<td>0</td>
<td>1075.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>225000.0</td>
<td>171342.0</td>
<td>NaN</td>
<td>0.0</td>
<td>Credit card</td>
<td>-20</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>215354</td>
<td>5714464</td>
<td>Active</td>
<td>currency 1</td>
<td>-203</td>
<td>0</td>
<td>528.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>464323.5</td>
<td>NaN</td>
<td>NaN</td>
<td>0.0</td>
<td>Consumer credit</td>
<td>-16</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>215354</td>
<td>5714465</td>
<td>Active</td>
<td>currency 1</td>
<td>-203</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>90000.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.0</td>
<td>Credit card</td>
<td>-16</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>215354</td>
<td>5714466</td>
<td>Active</td>
<td>currency 1</td>
<td>-629</td>
<td>0</td>
<td>1197.0</td>
<td>NaN</td>
<td>77674.5</td>
<td>0</td>
<td>2700000.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0.0</td>
<td>Consumer credit</td>
<td>-21</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sample-of-bureau_balance.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-bureau_balance.csv">1.5 Sample of <code>bureau_balance.csv</code></h2>
<ul>
<li><code>bureau_balance.csv</code> filtered again, this time to keep only rows that have values for <code>SK_ID_BUREAU</code>, which is the shared key between this file and <code>bureau.csv</code>. This enables merging the tables later.</li>
</ul>
<div id="5ff82fd5-3149-473b-b428-1c461732fbe9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="5">
<div class="cell-output cell-output-stdout">
<pre><code>
Bureau_Balance shape: (27299925, 3)

Columns:
['SK_ID_BUREAU', 'MONTHS_BALANCE', 'STATUS']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 27299925 entries, 0 to 27299924
Data columns (total 3 columns):
 #   Column          Dtype 
---  ------          ----- 
 0   SK_ID_BUREAU    int64 
 1   MONTHS_BALANCE  int64 
 2   STATUS          object
dtypes: int64(2), object(1)
memory usage: 624.8+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_BUREAU</th>
<th data-quarto-table-cell-role="th">MONTHS_BALANCE</th>
<th data-quarto-table-cell-role="th">STATUS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>5715448</td>
<td>0</td>
<td>C</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>5715448</td>
<td>-1</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>5715448</td>
<td>-2</td>
<td>C</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>5715448</td>
<td>-3</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5715448</td>
<td>-4</td>
<td>C</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sample-of-previous_application.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-previous_application.csv">1.6 Sample of <code>previous_application.csv</code></h2>
<ul>
<li>Filtered to keep only rows with <code>SK_ID_CURR</code>, which will be the joining column for the final table.</li>
</ul>
<div id="4567b979-847e-423f-a14a-14e0d7869d95" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="6">
<div class="cell-output cell-output-stdout">
<pre><code>
Previous Application shape: (1670214, 37)

Columns:
['SK_ID_PREV', 'SK_ID_CURR', 'NAME_CONTRACT_TYPE', 'AMT_ANNUITY', 'AMT_APPLICATION', 'AMT_CREDIT', 'AMT_DOWN_PAYMENT', 'AMT_GOODS_PRICE', 'WEEKDAY_APPR_PROCESS_START', 'HOUR_APPR_PROCESS_START', 'FLAG_LAST_APPL_PER_CONTRACT', 'NFLAG_LAST_APPL_IN_DAY', 'RATE_DOWN_PAYMENT', 'RATE_INTEREST_PRIMARY', 'RATE_INTEREST_PRIVILEGED', 'NAME_CASH_LOAN_PURPOSE', 'NAME_CONTRACT_STATUS', 'DAYS_DECISION', 'NAME_PAYMENT_TYPE', 'CODE_REJECT_REASON', 'NAME_TYPE_SUITE', 'NAME_CLIENT_TYPE', 'NAME_GOODS_CATEGORY', 'NAME_PORTFOLIO', 'NAME_PRODUCT_TYPE', 'CHANNEL_TYPE', 'SELLERPLACE_AREA', 'NAME_SELLER_INDUSTRY', 'CNT_PAYMENT', 'NAME_YIELD_GROUP', 'PRODUCT_COMBINATION', 'DAYS_FIRST_DRAWING', 'DAYS_FIRST_DUE', 'DAYS_LAST_DUE_1ST_VERSION', 'DAYS_LAST_DUE', 'DAYS_TERMINATION', 'NFLAG_INSURED_ON_APPROVAL']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1670214 entries, 0 to 1670213
Data columns (total 37 columns):
 #   Column                       Non-Null Count    Dtype  
---  ------                       --------------    -----  
 0   SK_ID_PREV                   1670214 non-null  int64  
 1   SK_ID_CURR                   1670214 non-null  int64  
 2   NAME_CONTRACT_TYPE           1670214 non-null  object 
 3   AMT_ANNUITY                  1297979 non-null  float64
 4   AMT_APPLICATION              1670214 non-null  float64
 5   AMT_CREDIT                   1670213 non-null  float64
 6   AMT_DOWN_PAYMENT             774370 non-null   float64
 7   AMT_GOODS_PRICE              1284699 non-null  float64
 8   WEEKDAY_APPR_PROCESS_START   1670214 non-null  object 
 9   HOUR_APPR_PROCESS_START      1670214 non-null  int64  
 10  FLAG_LAST_APPL_PER_CONTRACT  1670214 non-null  object 
 11  NFLAG_LAST_APPL_IN_DAY       1670214 non-null  int64  
 12  RATE_DOWN_PAYMENT            774370 non-null   float64
 13  RATE_INTEREST_PRIMARY        5951 non-null     float64
 14  RATE_INTEREST_PRIVILEGED     5951 non-null     float64
 15  NAME_CASH_LOAN_PURPOSE       1670214 non-null  object 
 16  NAME_CONTRACT_STATUS         1670214 non-null  object 
 17  DAYS_DECISION                1670214 non-null  int64  
 18  NAME_PAYMENT_TYPE            1670214 non-null  object 
 19  CODE_REJECT_REASON           1670214 non-null  object 
 20  NAME_TYPE_SUITE              849809 non-null   object 
 21  NAME_CLIENT_TYPE             1670214 non-null  object 
 22  NAME_GOODS_CATEGORY          1670214 non-null  object 
 23  NAME_PORTFOLIO               1670214 non-null  object 
 24  NAME_PRODUCT_TYPE            1670214 non-null  object 
 25  CHANNEL_TYPE                 1670214 non-null  object 
 26  SELLERPLACE_AREA             1670214 non-null  int64  
 27  NAME_SELLER_INDUSTRY         1670214 non-null  object 
 28  CNT_PAYMENT                  1297984 non-null  float64
 29  NAME_YIELD_GROUP             1670214 non-null  object 
 30  PRODUCT_COMBINATION          1669868 non-null  object 
 31  DAYS_FIRST_DRAWING           997149 non-null   float64
 32  DAYS_FIRST_DUE               997149 non-null   float64
 33  DAYS_LAST_DUE_1ST_VERSION    997149 non-null   float64
 34  DAYS_LAST_DUE                997149 non-null   float64
 35  DAYS_TERMINATION             997149 non-null   float64
 36  NFLAG_INSURED_ON_APPROVAL    997149 non-null   float64
dtypes: float64(15), int64(6), object(16)
memory usage: 471.5+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_PREV</th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_TYPE</th>
<th data-quarto-table-cell-role="th">AMT_ANNUITY</th>
<th data-quarto-table-cell-role="th">AMT_APPLICATION</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT</th>
<th data-quarto-table-cell-role="th">AMT_DOWN_PAYMENT</th>
<th data-quarto-table-cell-role="th">AMT_GOODS_PRICE</th>
<th data-quarto-table-cell-role="th">WEEKDAY_APPR_PROCESS_START</th>
<th data-quarto-table-cell-role="th">HOUR_APPR_PROCESS_START</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">NAME_SELLER_INDUSTRY</th>
<th data-quarto-table-cell-role="th">CNT_PAYMENT</th>
<th data-quarto-table-cell-role="th">NAME_YIELD_GROUP</th>
<th data-quarto-table-cell-role="th">PRODUCT_COMBINATION</th>
<th data-quarto-table-cell-role="th">DAYS_FIRST_DRAWING</th>
<th data-quarto-table-cell-role="th">DAYS_FIRST_DUE</th>
<th data-quarto-table-cell-role="th">DAYS_LAST_DUE_1ST_VERSION</th>
<th data-quarto-table-cell-role="th">DAYS_LAST_DUE</th>
<th data-quarto-table-cell-role="th">DAYS_TERMINATION</th>
<th data-quarto-table-cell-role="th">NFLAG_INSURED_ON_APPROVAL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2030495</td>
<td>271877</td>
<td>Consumer loans</td>
<td>1730.430</td>
<td>17145.0</td>
<td>17145.0</td>
<td>0.0</td>
<td>17145.0</td>
<td>SATURDAY</td>
<td>15</td>
<td>...</td>
<td>Connectivity</td>
<td>12.0</td>
<td>middle</td>
<td>POS mobile with interest</td>
<td>365243.0</td>
<td>-42.0</td>
<td>300.0</td>
<td>-42.0</td>
<td>-37.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2802425</td>
<td>108129</td>
<td>Cash loans</td>
<td>25188.615</td>
<td>607500.0</td>
<td>679671.0</td>
<td>NaN</td>
<td>607500.0</td>
<td>THURSDAY</td>
<td>11</td>
<td>...</td>
<td>XNA</td>
<td>36.0</td>
<td>low_action</td>
<td>Cash X-Sell: low</td>
<td>365243.0</td>
<td>-134.0</td>
<td>916.0</td>
<td>365243.0</td>
<td>365243.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2523466</td>
<td>122040</td>
<td>Cash loans</td>
<td>15060.735</td>
<td>112500.0</td>
<td>136444.5</td>
<td>NaN</td>
<td>112500.0</td>
<td>TUESDAY</td>
<td>11</td>
<td>...</td>
<td>XNA</td>
<td>12.0</td>
<td>high</td>
<td>Cash X-Sell: high</td>
<td>365243.0</td>
<td>-271.0</td>
<td>59.0</td>
<td>365243.0</td>
<td>365243.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2819243</td>
<td>176158</td>
<td>Cash loans</td>
<td>47041.335</td>
<td>450000.0</td>
<td>470790.0</td>
<td>NaN</td>
<td>450000.0</td>
<td>MONDAY</td>
<td>7</td>
<td>...</td>
<td>XNA</td>
<td>12.0</td>
<td>middle</td>
<td>Cash X-Sell: middle</td>
<td>365243.0</td>
<td>-482.0</td>
<td>-152.0</td>
<td>-182.0</td>
<td>-177.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1784265</td>
<td>202054</td>
<td>Cash loans</td>
<td>31924.395</td>
<td>337500.0</td>
<td>404055.0</td>
<td>NaN</td>
<td>337500.0</td>
<td>THURSDAY</td>
<td>9</td>
<td>...</td>
<td>XNA</td>
<td>24.0</td>
<td>high</td>
<td>Cash Street: high</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5 rows × 37 columns</p>
</div>
</div>
</div>
</section>
<section id="sample-of-pos_cash_balance.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-pos_cash_balance.csv">1.7 Sample of <code>POS_cash_balance.csv</code></h2>
<ul>
<li>This table shares <code>SK_ID_PREV</code> with with <code>previous_applications.csv</code>, so we filter only for rows that have this key for later merging.</li>
</ul>
<div id="5efaad26-79fc-4ad9-a8fa-d488934ff084" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="7">
<div class="cell-output cell-output-stdout">
<pre><code>
POS_CASH Balance shape: (10001358, 8)

Columns:
['SK_ID_PREV', 'SK_ID_CURR', 'MONTHS_BALANCE', 'CNT_INSTALMENT', 'CNT_INSTALMENT_FUTURE', 'NAME_CONTRACT_STATUS', 'SK_DPD', 'SK_DPD_DEF']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 10001358 entries, 0 to 10001357
Data columns (total 8 columns):
 #   Column                 Dtype  
---  ------                 -----  
 0   SK_ID_PREV             int64  
 1   SK_ID_CURR             int64  
 2   MONTHS_BALANCE         int64  
 3   CNT_INSTALMENT         float64
 4   CNT_INSTALMENT_FUTURE  float64
 5   NAME_CONTRACT_STATUS   object 
 6   SK_DPD                 int64  
 7   SK_DPD_DEF             int64  
dtypes: float64(2), int64(5), object(1)
memory usage: 610.4+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_PREV</th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">MONTHS_BALANCE</th>
<th data-quarto-table-cell-role="th">CNT_INSTALMENT</th>
<th data-quarto-table-cell-role="th">CNT_INSTALMENT_FUTURE</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_STATUS</th>
<th data-quarto-table-cell-role="th">SK_DPD</th>
<th data-quarto-table-cell-role="th">SK_DPD_DEF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1803195</td>
<td>182943</td>
<td>-31</td>
<td>48.0</td>
<td>45.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1715348</td>
<td>367990</td>
<td>-33</td>
<td>36.0</td>
<td>35.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1784872</td>
<td>397406</td>
<td>-32</td>
<td>12.0</td>
<td>9.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1903291</td>
<td>269225</td>
<td>-35</td>
<td>48.0</td>
<td>42.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2341044</td>
<td>334279</td>
<td>-35</td>
<td>36.0</td>
<td>35.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sample-of-installments_payments.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-installments_payments.csv">1.8 Sample of <code>installments_payments.csv</code></h2>
<ul>
<li>This table also shares <code>SK_ID_PREV</code> with with <code>previous_applications.csv</code>, so I filter only for rows that have this key for later merging.</li>
</ul>
<div id="558932b6-b064-437d-ba9f-ab39f6f284a4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>
Installments Payments shape: (13605401, 8)

Columns:
['SK_ID_PREV', 'SK_ID_CURR', 'NUM_INSTALMENT_VERSION', 'NUM_INSTALMENT_NUMBER', 'DAYS_INSTALMENT', 'DAYS_ENTRY_PAYMENT', 'AMT_INSTALMENT', 'AMT_PAYMENT']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 13605401 entries, 0 to 13605400
Data columns (total 8 columns):
 #   Column                  Dtype  
---  ------                  -----  
 0   SK_ID_PREV              int64  
 1   SK_ID_CURR              int64  
 2   NUM_INSTALMENT_VERSION  float64
 3   NUM_INSTALMENT_NUMBER   int64  
 4   DAYS_INSTALMENT         float64
 5   DAYS_ENTRY_PAYMENT      float64
 6   AMT_INSTALMENT          float64
 7   AMT_PAYMENT             float64
dtypes: float64(5), int64(3)
memory usage: 830.4 MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_PREV</th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">NUM_INSTALMENT_VERSION</th>
<th data-quarto-table-cell-role="th">NUM_INSTALMENT_NUMBER</th>
<th data-quarto-table-cell-role="th">DAYS_INSTALMENT</th>
<th data-quarto-table-cell-role="th">DAYS_ENTRY_PAYMENT</th>
<th data-quarto-table-cell-role="th">AMT_INSTALMENT</th>
<th data-quarto-table-cell-role="th">AMT_PAYMENT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1054186</td>
<td>161674</td>
<td>1.0</td>
<td>6</td>
<td>-1180.0</td>
<td>-1187.0</td>
<td>6948.360</td>
<td>6948.360</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1330831</td>
<td>151639</td>
<td>0.0</td>
<td>34</td>
<td>-2156.0</td>
<td>-2156.0</td>
<td>1716.525</td>
<td>1716.525</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2085231</td>
<td>193053</td>
<td>2.0</td>
<td>1</td>
<td>-63.0</td>
<td>-63.0</td>
<td>25425.000</td>
<td>25425.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2452527</td>
<td>199697</td>
<td>1.0</td>
<td>3</td>
<td>-2418.0</td>
<td>-2426.0</td>
<td>24350.130</td>
<td>24350.130</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2714724</td>
<td>167756</td>
<td>1.0</td>
<td>2</td>
<td>-1383.0</td>
<td>-1366.0</td>
<td>2165.040</td>
<td>2160.585</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sample-of-credit_card_balance.csv" class="level2">
<h2 class="anchored" data-anchor-id="sample-of-credit_card_balance.csv">1.9 Sample of <code>credit_card_balance.csv</code></h2>
<ul>
<li>This table also shares <code>SK_ID_PREV</code> with with <code>previous_applications.csv</code>, so I filter only for rows that have this key for later merging.</li>
</ul>
<div id="777d0cac-e9ca-48db-ac29-1325b29af063" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="9">
<div class="cell-output cell-output-stdout">
<pre><code>
Credit Card Balance shape: (3840312, 23)

Columns:
['SK_ID_PREV', 'SK_ID_CURR', 'MONTHS_BALANCE', 'AMT_BALANCE', 'AMT_CREDIT_LIMIT_ACTUAL', 'AMT_DRAWINGS_ATM_CURRENT', 'AMT_DRAWINGS_CURRENT', 'AMT_DRAWINGS_OTHER_CURRENT', 'AMT_DRAWINGS_POS_CURRENT', 'AMT_INST_MIN_REGULARITY', 'AMT_PAYMENT_CURRENT', 'AMT_PAYMENT_TOTAL_CURRENT', 'AMT_RECEIVABLE_PRINCIPAL', 'AMT_RECIVABLE', 'AMT_TOTAL_RECEIVABLE', 'CNT_DRAWINGS_ATM_CURRENT', 'CNT_DRAWINGS_CURRENT', 'CNT_DRAWINGS_OTHER_CURRENT', 'CNT_DRAWINGS_POS_CURRENT', 'CNT_INSTALMENT_MATURE_CUM', 'NAME_CONTRACT_STATUS', 'SK_DPD', 'SK_DPD_DEF']

Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3840312 entries, 0 to 3840311
Data columns (total 23 columns):
 #   Column                      Dtype  
---  ------                      -----  
 0   SK_ID_PREV                  int64  
 1   SK_ID_CURR                  int64  
 2   MONTHS_BALANCE              int64  
 3   AMT_BALANCE                 float64
 4   AMT_CREDIT_LIMIT_ACTUAL     int64  
 5   AMT_DRAWINGS_ATM_CURRENT    float64
 6   AMT_DRAWINGS_CURRENT        float64
 7   AMT_DRAWINGS_OTHER_CURRENT  float64
 8   AMT_DRAWINGS_POS_CURRENT    float64
 9   AMT_INST_MIN_REGULARITY     float64
 10  AMT_PAYMENT_CURRENT         float64
 11  AMT_PAYMENT_TOTAL_CURRENT   float64
 12  AMT_RECEIVABLE_PRINCIPAL    float64
 13  AMT_RECIVABLE               float64
 14  AMT_TOTAL_RECEIVABLE        float64
 15  CNT_DRAWINGS_ATM_CURRENT    float64
 16  CNT_DRAWINGS_CURRENT        int64  
 17  CNT_DRAWINGS_OTHER_CURRENT  float64
 18  CNT_DRAWINGS_POS_CURRENT    float64
 19  CNT_INSTALMENT_MATURE_CUM   float64
 20  NAME_CONTRACT_STATUS        object 
 21  SK_DPD                      int64  
 22  SK_DPD_DEF                  int64  
dtypes: float64(15), int64(7), object(1)
memory usage: 673.9+ MB
None

Preview</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SK_ID_PREV</th>
<th data-quarto-table-cell-role="th">SK_ID_CURR</th>
<th data-quarto-table-cell-role="th">MONTHS_BALANCE</th>
<th data-quarto-table-cell-role="th">AMT_BALANCE</th>
<th data-quarto-table-cell-role="th">AMT_CREDIT_LIMIT_ACTUAL</th>
<th data-quarto-table-cell-role="th">AMT_DRAWINGS_ATM_CURRENT</th>
<th data-quarto-table-cell-role="th">AMT_DRAWINGS_CURRENT</th>
<th data-quarto-table-cell-role="th">AMT_DRAWINGS_OTHER_CURRENT</th>
<th data-quarto-table-cell-role="th">AMT_DRAWINGS_POS_CURRENT</th>
<th data-quarto-table-cell-role="th">AMT_INST_MIN_REGULARITY</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">AMT_RECIVABLE</th>
<th data-quarto-table-cell-role="th">AMT_TOTAL_RECEIVABLE</th>
<th data-quarto-table-cell-role="th">CNT_DRAWINGS_ATM_CURRENT</th>
<th data-quarto-table-cell-role="th">CNT_DRAWINGS_CURRENT</th>
<th data-quarto-table-cell-role="th">CNT_DRAWINGS_OTHER_CURRENT</th>
<th data-quarto-table-cell-role="th">CNT_DRAWINGS_POS_CURRENT</th>
<th data-quarto-table-cell-role="th">CNT_INSTALMENT_MATURE_CUM</th>
<th data-quarto-table-cell-role="th">NAME_CONTRACT_STATUS</th>
<th data-quarto-table-cell-role="th">SK_DPD</th>
<th data-quarto-table-cell-role="th">SK_DPD_DEF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2562384</td>
<td>378907</td>
<td>-6</td>
<td>56.970</td>
<td>135000</td>
<td>0.0</td>
<td>877.5</td>
<td>0.0</td>
<td>877.5</td>
<td>1700.325</td>
<td>...</td>
<td>0.000</td>
<td>0.000</td>
<td>0.0</td>
<td>1</td>
<td>0.0</td>
<td>1.0</td>
<td>35.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2582071</td>
<td>363914</td>
<td>-1</td>
<td>63975.555</td>
<td>45000</td>
<td>2250.0</td>
<td>2250.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2250.000</td>
<td>...</td>
<td>64875.555</td>
<td>64875.555</td>
<td>1.0</td>
<td>1</td>
<td>0.0</td>
<td>0.0</td>
<td>69.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1740877</td>
<td>371185</td>
<td>-7</td>
<td>31815.225</td>
<td>450000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2250.000</td>
<td>...</td>
<td>31460.085</td>
<td>31460.085</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>30.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1389973</td>
<td>337855</td>
<td>-4</td>
<td>236572.110</td>
<td>225000</td>
<td>2250.0</td>
<td>2250.0</td>
<td>0.0</td>
<td>0.0</td>
<td>11795.760</td>
<td>...</td>
<td>233048.970</td>
<td>233048.970</td>
<td>1.0</td>
<td>1</td>
<td>0.0</td>
<td>0.0</td>
<td>10.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1891521</td>
<td>126868</td>
<td>-1</td>
<td>453919.455</td>
<td>450000</td>
<td>0.0</td>
<td>11547.0</td>
<td>0.0</td>
<td>11547.0</td>
<td>22924.890</td>
<td>...</td>
<td>453919.455</td>
<td>453919.455</td>
<td>0.0</td>
<td>1</td>
<td>0.0</td>
<td>1.0</td>
<td>101.0</td>
<td>Active</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 23 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="section-2-encode-aggregate-and-merge" class="level1">
<h1>Section 2: Encode, aggregate, and merge</h1>
<hr>
<ul>
<li>One-Hot encoding is used (as opposed to LabelEncoder or OrdinalEncoder) because it is the most appropriate method for encoding nominal variables. Other methods would introduce a false sense of order among the classes.</li>
</ul>
<section id="load-samples" class="level2">
<h2 class="anchored" data-anchor-id="load-samples">2.1 Load samples</h2>
<ul>
<li>Store sampled datasets into variables for merging.</li>
</ul>
</section>
<section id="encode-and-aggregate-bureau_bal_sample" class="level2">
<h2 class="anchored" data-anchor-id="encode-and-aggregate-bureau_bal_sample">2.2 Encode and aggregate <code>bureau_bal_sample</code></h2>
<ul>
<li><code>STATUS</code> is appropriate for one-hot encoding since it has low dimensionality and is potentially predictive of the target variable.
<ul>
<li>It contains categorical credit status codes (<code>0</code>, <code>1</code>, …, <code>5</code>, <code>C</code>, <code>X</code>) indicating the repayment behavior of each loan over time.</li>
<li>It is then aggregated by <code>SK_ID_BUREAU</code> to ensure one row per key.</li>
<li>The mean is used here to summarize each applicant’s monthly repayment behavior (for example: <code>1.0</code> IN <code>STATUS_0</code> means credit was always current, while <code>0.5</code> means it was current in half of the recorded months).</li>
</ul></li>
<li>Columns are prepended with <code>BB_</code> to indicate that they originated from the <code>bureau_balance</code> table to improve traceablility during feature engineering.</li>
<li>The index of bureau_bal_agg is reset so that SK_ID_BUREAU turns back into a regular column rather than a DataFrame index (which it became after the aggregation). This enables merging in the next step.</li>
</ul>
</section>
<section id="merge-bureau_bal_sample-with-bureau_sample-into-bureau_merged" class="level2">
<h2 class="anchored" data-anchor-id="merge-bureau_bal_sample-with-bureau_sample-into-bureau_merged">2.3 Merge <code>bureau_bal_sample</code> with <code>bureau_sample</code> into <code>bureau_merged</code></h2>
<ul>
<li>Their shared key is <code>SK_ID_BUREAU</code>, which represents individual previous credit card accounts.</li>
<li>The resulting table <code>bureau_merged</code> still contains multiple rows for <code>SK_ID_CURR</code>, which will be fixed by aggregating to this key.</li>
</ul>
</section>
<section id="encode-and-aggregate-bureau_merged-into-bureau_agg" class="level2">
<h2 class="anchored" data-anchor-id="encode-and-aggregate-bureau_merged-into-bureau_agg">2.4 Encode and aggregate <code>bureau_merged</code> into <code>bureau_agg</code></h2>
<ul>
<li>First, <code>bureau_merged</code> features <code>CREDIT_ACTIVE</code> AND <code>CREDIT_TYPE</code> are one-hot encoded.
<ul>
<li><code>CREDIT_ACTIVE</code>: Current status of a credit line at the time of loan application.
<ul>
<li>Classes: [“Active”, “Closed”, “Sold”, “Bad debt”]</li>
<li>This is a strong indicator of financial responsibility:
<ul>
<li>Active accounts could mean that the client has increased financial obligations which may signal risk.</li>
<li>Closed accounts indicate that their loans have been fully repaid, which is positive evidence of financial responsibility.</li>
<li>Sold / Bad debt / Charged off values may indicate that the lender offloaded the account due to deliquency, a potential red flag.</li>
</ul></li>
</ul></li>
<li><code>CREDIT_TYPE</code>: Type of credit product associated with each SK_ID_BUREAU.
<ul>
<li>Classes (common occurrences): [“Consumer credit”, “Credit card”, “Car loan”, “Mortgage”, “Microloan”, “Loan for business development / working capital replinishment”]</li>
<li>This feature provides context into financial behaviors:
<ul>
<li>Clients with many credit cards may carry more short term debt, which indicates higher risk for a long-term home loan.</li>
<li>Presence of mortages suggest that the corresponding clients have a higher income / higher ability to satisfy loan requirements.</li>
</ul></li>
</ul></li>
</ul></li>
<li>Boolean columns are included because, when averaged, these columns represent the proportion of credit lines matching each condition — for example: the percentage of a client’s previous credits that are still active, or that were mortgages.</li>
<li><code>BUREAU_</code> is prepended to aggregated columns for traceability.</li>
</ul>
</section>
<section id="merge-bureau_agg-with-app_sample-into-app_with_bureau" class="level2">
<h2 class="anchored" data-anchor-id="merge-bureau_agg-with-app_sample-into-app_with_bureau">2.5 Merge <code>bureau_agg</code> with <code>app_sample</code> into <code>app_with_bureau</code></h2>
<ul>
<li>Now that <code>bureau_agg</code> is aggregated such that it has only one row per <code>SK_ID_CURR</code>, it can now be merged with the main table <code>app_sample</code>.</li>
<li><code>app_sample</code> is renamed to <code>app_with_bureau</code>, and will be renamed with each merge to clarify what it contains at each merging step.</li>
</ul>
</section>
<section id="load-and-encode-sample_previous_application" class="level2">
<h2 class="anchored" data-anchor-id="load-and-encode-sample_previous_application">2.6 Load and encode <code>sample_previous_application</code></h2>
<ul>
<li>This table will eventually be merged alongside <code>POS_CASH_balance</code>, <code>installments_payments</code>, and <code>credit_card_balance</code> to enrich the <code>app_sample</code> records.</li>
<li>One-hot encoding is applied here to categorical variables so that downstream models (LightGBM, XGBoost, Logistic Regression) can interpret them numerically.</li>
</ul>
</section>
<section id="aggregate-numeric-columns-into-prev_agg" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-numeric-columns-into-prev_agg">2.7 Aggregate numeric columns into <code>prev_agg</code></h2>
<ul>
<li>Since one column per <code>SK_ID_CURR</code> is needed, aggregate values of numerical and bool types (for reasons described above) are taken to facilitate this.</li>
</ul>
</section>
<section id="merge-sampled-previous_application-with-main-table-on-sk_id_curr" class="level2">
<h2 class="anchored" data-anchor-id="merge-sampled-previous_application-with-main-table-on-sk_id_curr">2.8 Merge sampled <code>previous_application</code> with main table on <code>SK_ID_CURR</code></h2>
</section>
<section id="load-sampled-pos_cash_balance" class="level2">
<h2 class="anchored" data-anchor-id="load-sampled-pos_cash_balance">2.9 Load sampled <code>POS_CASH_balance</code></h2>
<ul>
<li>Will be merged with sampled <code>previous_application</code> on SK_ID_PREV</li>
</ul>
</section>
<section id="aggregate-numerical-features-from-sampled-pos_cash_balance" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-numerical-features-from-sampled-pos_cash_balance">2.10 Aggregate numerical features from sampled <code>POS_CASH_balance</code></h2>
<ul>
<li>Summary of repayment activity for each loan (past loans with Home Credit)</li>
<li>Features are grouped by <code>SK_ID_PREV</code> (one row per loan) and summary statistics are computed:
<ul>
<li><code>MONTHS_BALANCE</code>: how far back the record goes (<code>min</code>, <code>max</code>) and how many months are recorded (<code>count</code>)</li>
<li><code>SK_DPD</code>, <code>SK_DPD_DEF</code>: days past due / chronic delinquency</li>
<li><code>CNT_INSTALMENT</code>: total scheduled installments</li>
<li><code>CNT_INSTALMENT_FUTURE</code>: number of remaining scheduled installments on the loan at the time of observation</li>
</ul></li>
</ul>
</section>
<section id="merge-sampled-and-aggregated-pos_cash_balance-with-sampled-previous_application-on-sk_id_prev" class="level2">
<h2 class="anchored" data-anchor-id="merge-sampled-and-aggregated-pos_cash_balance-with-sampled-previous_application-on-sk_id_prev">2.11 Merge sampled and aggregated <code>POS_CASH_balance</code> with sampled <code>previous_application</code> on <code>SK_ID_PREV</code></h2>
<ul>
<li><code>SK_ID_PREV</code> is shared by these two columns, and both that key and <code>SK_ID_CURR</code> are present in <code>prev</code>, so this is a precursor to a merge with the main table.</li>
<li>There are still multiple <code>SK_ID_PREV</code> values per <code>SK_ID_CURR</code>, so and second aggregation (mean) is taken to consolidate columns while retaining information.</li>
<li><code>SK_ID_PREV</code> is now redundant and is dropped.</li>
<li>Sampled <code>POS_CASH_balance</code> is merged with the main table, and main table is renamed for clarity.</li>
</ul>
</section>
<section id="load-sampled-installments_payments" class="level2">
<h2 class="anchored" data-anchor-id="load-sampled-installments_payments">2.12 Load sampled <code>installments_payments</code></h2>
</section>
<section id="required-feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="required-feature-engineering">2.13 Required feature engineering</h2>
<ul>
<li>New features are created for <code>installments_payments</code> to illustrate repayment behavior relative to scheduled payment plans.
<ul>
<li>These features provide insight into timeliness and consistency in past repayment history, which is presumably predictive of credit risk.</li>
</ul></li>
<li>New features:
<ul>
<li><code>PAYMENT_DIFF_DAYS</code>: Difference between actual payment date and scheduled payment date. Positive values = late payments; Negative values = early payments.</li>
<li><code>PAYMENT_RATIO</code>: Ratio of actual amount paid to scheduled installment amount. Values &gt; 1 = overpayment; Values &lt; 1 = underpayment.</li>
<li><code>PAYMENT_DIFF_AMT</code>: Difference between amount paid and expected amount. Positive = overpayment; Negative = underpayment.</li>
</ul></li>
<li>Numerical features from <code>installments_payments</code> are then aggregated in same manner as previous tables.</li>
<li>This table is first merged with the <code>SK_ID_PREV</code> and <code>SK_ID_CURR</code> columns of <code>previous_application</code> on <code>SK_ID_PREV</code>, which facilitates a later merge with sampled <code>application_train</code></li>
</ul>
</section>
<section id="load-sampled-credit_card_balance" class="level2">
<h2 class="anchored" data-anchor-id="load-sampled-credit_card_balance">2.14 Load sampled <code>credit_card_balance</code></h2>
</section>
<section id="aggregate-time-based-features-from-credit_card_balance-on-sk_id_prev-merge-with-previous_application-merge-with-main-table" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-time-based-features-from-credit_card_balance-on-sk_id_prev-merge-with-previous_application-merge-with-main-table">2.15 Aggregate time-based features from <code>credit_card_balance</code> on <code>SK_ID_PREV</code>, merge with <code>previous_application</code>, merge with main table</h2>
<ul>
<li>Summarizes clients’ historical credit card behavior by aggregating monthly balance snapshots per previous credit line (<code>SK_ID_PREV</code>)</li>
<li>One row per previous credit card (later aggregated by application)</li>
<li>Aggregations:
<ul>
<li><code>MONTHS_BALANCE</code>: information about how long client has had these credit lines</li>
<li><code>AMT_BALANCE</code>, <code>AMT_TOTAL_RECEIVABLE</code>: outstanding balances</li>
<li><code>AMT_CREDIT_LIMIT_ACTUAL</code>: typical credit limit given</li>
<li><code>AMT_DRAWINGS</code>, <code>CNT_DRAWINGS</code>: how much / how often client withdrew and spent with credit card</li>
<li><code>CNT_INSTALMENT_MATURE_CUM</code>: number of fully paid installments (strong indicator of target)</li>
<li><code>SK_DPD</code>, <code>SK_DPD_DEF</code>: days past due (DPD) - repayment risk</li>
</ul></li>
</ul>
</section>
<section id="final-sampled-table" class="level2">
<h2 class="anchored" data-anchor-id="final-sampled-table">2.16 Final (sampled) table</h2>
</section>
</section>
<section id="section-3-preprocessing" class="level1">
<h1>Section 3: Preprocessing</h1>
<hr>
<p>This section prepares the final dataset (<code>app_final</code>) for modeling by conducting a series of sanity checks, column transformations, and imputations.</p>
<section id="initial-checks-and-cleanup" class="level2">
<h2 class="anchored" data-anchor-id="initial-checks-and-cleanup">3.1 Initial checks and cleanup</h2>
<ul>
<li>Copy of <code>all_final</code> is made</li>
<li>Nulls are inspected</li>
</ul>
<div id="dba5b91d-7877-4aeb-952a-b543ee14b61a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="36">
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dtype</th>
<th data-quarto-table-cell-role="th">null_count</th>
<th data-quarto-table-cell-role="th">null_ratio</th>
<th data-quarto-table-cell-role="th">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_STD</td>
<td>float64</td>
<td>30734</td>
<td>0.999447</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_STD</td>
<td>float64</td>
<td>30734</td>
<td>0.999447</td>
<td>14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MEAN</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MEAN</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MAX</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIVILEGED_MIN</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MIN</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>41</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PREVAPP_RATE_INTEREST_PRIMARY_MAX</td>
<td>float64</td>
<td>30330</td>
<td>0.986309</td>
<td>42</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_PAYMENT_CURRENT_MEAN</td>
<td>float64</td>
<td>25555</td>
<td>0.831030</td>
<td>5039</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_ATM_CURRENT_MEAN</td>
<td>float64</td>
<td>25526</td>
<td>0.830087</td>
<td>3213</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_OTHER_CURRENT_MEAN</td>
<td>float64</td>
<td>25526</td>
<td>0.830087</td>
<td>165</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">BUREAU_AMT_ANNUITY_STD</td>
<td>float64</td>
<td>24462</td>
<td>0.795486</td>
<td>3960</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_SK_DPD_DEF_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>447</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_MONTHS_BALANCE_MIN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>107</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_CURRENT_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>2207</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_MONTHS_BALANCE_COUNT</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>105</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_MONTHS_BALANCE_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_TOTAL_RECEIVABLE_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>5008</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_TOTAL_RECEIVABLE_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>5104</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_PAYMENT_CURRENT_SUM</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>4952</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_SK_DPD_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>697</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_BALANCE_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>5037</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_CURRENT_SUM</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>4236</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_SK_DPD_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>123</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_SK_DPD_DEF_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>21</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_BALANCE_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>5121</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_AMT_CREDIT_LIMIT_ACTUAL_MEAN</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>2434</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_CNT_DRAWINGS_CURRENT_SUM</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>304</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_CNT_INSTALMENT_MATURE_CUM_MAX</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>104</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_AMT_DRAWINGS_ATM_CURRENT_SUM</td>
<td>float64</td>
<td>23030</td>
<td>0.748919</td>
<td>1529</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="drop-columns-with-nulls-95" class="level2">
<h2 class="anchored" data-anchor-id="drop-columns-with-nulls-95">3.2 Drop columns with nulls &gt; 95%</h2>
<ul>
<li>These columns are likely to introduce noise into modeling and are thus dropped.</li>
</ul>
</section>
<section id="outlier-clipping" class="level2">
<h2 class="anchored" data-anchor-id="outlier-clipping">3.3 Outlier clipping</h2>
<p>To reduce the impact of extreme values without removing valuable training data, this step applies winzorization to all numeric features.</p>
<ul>
<li>The top and bottom 1% of values in each column are clipped to reduce skew and stabilize model training.</li>
<li>This approach is more appropriate than row deletion for large, high-dimensional datasets where some outliers may carry signal.</li>
</ul>
</section>
<section id="data-splits" class="level2">
<h2 class="anchored" data-anchor-id="data-splits">3.4 Data splits</h2>
<p>This section performs the initial split between features (<code>X</code>) and target (<code>y</code>) in preparation for modeling. Additional preprocessing is applied to ensure that all features are numeric and model-compatible:</p>
<ul>
<li><code>SK_ID_CURR</code> (identifier) and <code>TARGET</code> (label) are dropped from <code>X</code>, and <code>TARGET</code> is assigned to <code>y</code>.</li>
<li>Columns stored as <code>object</code> type are encoded to numeric where possible.</li>
<li>Remaining <code>object</code> columns (true categoricals) are one-hot encoded using <code>pd.get_dummies()</code> to ensure compatibility with all models, including those that do not support categorical features natively.</li>
<li><code>dummy_na=True</code> ensures that missing categorical values are explicitly handled and represented as separate dummy variables.</li>
</ul>
</section>
<section id="impute-nulls-with-zero-or-median" class="level2">
<h2 class="anchored" data-anchor-id="impute-nulls-with-zero-or-median">3.5 Impute nulls with zero or median</h2>
<p>This step handles applies two different imputation methods based on the meaning of each feature:</p>
<ul>
<li>Zero imputation is applied to aggregated features originating from time-series or transactional data (e.g., <code>CC_</code>, <code>POS_</code>, <code>INSTALL_</code>, <code>BUREAU_</code>, <code>PREVAPP_</code>).
<ul>
<li>These missing values typically indicate an absence of activity, so filling them with 0 is both safe and meaningful.</li>
</ul></li>
<li>Median imputation is used for all remaining features.
<ul>
<li>This helps preserve the overall distribution of each feature while minimizing the influence of extreme values.</li>
</ul></li>
</ul>
<div id="2b0df293-9d5b-464a-8b4a-6341dbb3f848" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;outputs_hidden&quot;:true,&quot;source_hidden&quot;:true}}" data-execution_count="41">
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>True</code></pre>
</div>
</div>
</section>
<section id="trainvaltest-splits" class="level2">
<h2 class="anchored" data-anchor-id="trainvaltest-splits">3.6 Train/val/test splits</h2>
<ul>
<li>Data is split 60/20/20, with both scaled and unscaled versions for the various models that will be tested.</li>
<li>Indexes between scaled and unscaled sets are aligned.</li>
</ul>
</section>
</section>
<section id="section-4-modeling" class="level1">
<h1>Section 4: Modeling</h1>
<hr>
<section id="logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression">4.1 Logistic Regression</h2>
<ul>
<li>Performance baseline using logistic regression on scaled features.</li>
<li>Threshold tuning is applied to ensure optimal results. Further refinement is reserved for the following models.</li>
</ul>
<div id="9256a6ed-9909-42a3-a32e-707aca36d04b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="43">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold: 0.05 | Precision: 0.087 | Recall: 0.978 | F1: 0.159
Threshold: 0.10 | Precision: 0.093 | Recall: 0.950 | F1: 0.170
Threshold: 0.15 | Precision: 0.100 | Recall: 0.915 | F1: 0.180
Threshold: 0.20 | Precision: 0.108 | Recall: 0.877 | F1: 0.192
Threshold: 0.25 | Precision: 0.117 | Recall: 0.847 | F1: 0.206
Threshold: 0.30 | Precision: 0.125 | Recall: 0.802 | F1: 0.217
Threshold: 0.35 | Precision: 0.135 | Recall: 0.764 | F1: 0.230
Threshold: 0.40 | Precision: 0.142 | Recall: 0.706 | F1: 0.237
Threshold: 0.45 | Precision: 0.154 | Recall: 0.655 | F1: 0.249
Threshold: 0.50 | Precision: 0.166 | Recall: 0.605 | F1: 0.260
Threshold: 0.55 | Precision: 0.180 | Recall: 0.560 | F1: 0.273
Threshold: 0.60 | Precision: 0.195 | Recall: 0.510 | F1: 0.283
Threshold: 0.65 | Precision: 0.210 | Recall: 0.446 | F1: 0.286
Threshold: 0.70 | Precision: 0.228 | Recall: 0.379 | F1: 0.284
Threshold: 0.75 | Precision: 0.250 | Recall: 0.315 | F1: 0.279
Threshold: 0.80 | Precision: 0.283 | Recall: 0.252 | F1: 0.267
Threshold: 0.85 | Precision: 0.315 | Recall: 0.187 | F1: 0.234
Threshold: 0.90 | Precision: 0.388 | Recall: 0.127 | F1: 0.191</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-44-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Logistic Regression (Final Test Performance @ Threshold = 0.65)
[[4766  881]
 [ 287  217]]
              precision    recall  f1-score   support

           0      0.943     0.844     0.891      5647
           1      0.198     0.431     0.271       504

    accuracy                          0.810      6151
   macro avg      0.570     0.637     0.581      6151
weighted avg      0.882     0.810     0.840      6151
</code></pre>
</div>
</div>
</section>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">4.2 Random Forest</h2>
<ul>
<li>A Random Forest classifier is trained as a second baseline model, leveraging its ability to handle complex, non-linear feature interactions without requiring feature scaling.</li>
<li>The initial model uses default hyperparameters with class balancing enabled to account for severe class imbalance in the target variable.</li>
<li>Performance is evaluated using AUC, precision, recall, F1-score, and a confusion matrix, using a default threshold of 0.5.</li>
<li>Optuna is then used to perform hyperparameter tuning with cross-validated AUC as the objective function.</li>
<li>The best model from the Optuna search is retrained, and a threshold sweep is conducted to identify the optimal decision threshold for classification.</li>
<li>Final evaluation is performed on the holdout test set using the tuned threshold.</li>
</ul>
<section id="initial-model-default-parameters" class="level3">
<h3 class="anchored" data-anchor-id="initial-model-default-parameters">Initial model (default parameters)</h3>
<div id="65be09d4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="44">
<div class="cell-output cell-output-stdout">
<pre><code>Initial Random Forest (Threshold = 0.5)
AUC: 0.6976
              precision    recall  f1-score   support

           0      0.918     1.000     0.957      5647
           1      0.500     0.002     0.004       504

    accuracy                          0.918      6151
   macro avg      0.709     0.501     0.481      6151
weighted avg      0.884     0.918     0.879      6151

[[5646    1]
 [ 503    1]]</code></pre>
</div>
</div>
</section>
<section id="hyperparameter-tuning-with-optuna" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning-with-optuna">Hyperparameter Tuning with Optuna</h3>
<div id="db7eaf33" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="45">
<div class="cell-output cell-output-stdout">
<pre><code>Best AUC : 0.7672
Best Parameters:
n_estimators: 779
max_depth: 16
min_samples_split: 18
min_samples_leaf: 19
max_features: None
class_weight: balanced_subsample</code></pre>
</div>
</div>
</section>
<section id="retrain-and-threshold-tuning" class="level3">
<h3 class="anchored" data-anchor-id="retrain-and-threshold-tuning">Retrain and Threshold Tuning</h3>
<div id="39ed1535" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="46">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold Tuning Results
Threshold: 0.05 | Precision: 0.083 | Recall: 0.994 | F1: 0.154
Threshold: 0.10 | Precision: 0.094 | Recall: 0.964 | F1: 0.172
Threshold: 0.15 | Precision: 0.111 | Recall: 0.895 | F1: 0.197
Threshold: 0.20 | Precision: 0.132 | Recall: 0.813 | F1: 0.227
Threshold: 0.25 | Precision: 0.152 | Recall: 0.712 | F1: 0.251
Threshold: 0.30 | Precision: 0.175 | Recall: 0.603 | F1: 0.271
Threshold: 0.35 | Precision: 0.197 | Recall: 0.510 | F1: 0.284
Threshold: 0.40 | Precision: 0.222 | Recall: 0.427 | F1: 0.292
Threshold: 0.45 | Precision: 0.247 | Recall: 0.349 | F1: 0.289
Threshold: 0.50 | Precision: 0.269 | Recall: 0.276 | F1: 0.273
Threshold: 0.55 | Precision: 0.285 | Recall: 0.212 | F1: 0.243
Threshold: 0.60 | Precision: 0.308 | Recall: 0.145 | F1: 0.197
Threshold: 0.65 | Precision: 0.346 | Recall: 0.093 | F1: 0.147
Threshold: 0.70 | Precision: 0.342 | Recall: 0.054 | F1: 0.093
Threshold: 0.75 | Precision: 0.464 | Recall: 0.026 | F1: 0.049
Threshold: 0.80 | Precision: 0.600 | Recall: 0.006 | F1: 0.012
Threshold: 0.85 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.90 | Precision: 0.000 | Recall: 0.000 | F1: 0.000</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-47-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Final Evaluation (Threshold = 0.40)
AUC: 0.7401
              precision    recall  f1-score   support

           0      0.944     0.866     0.904      5647
           1      0.222     0.427     0.292       504

    accuracy                          0.830      6151
   macro avg      0.583     0.646     0.598      6151
weighted avg      0.885     0.830     0.853      6151

[[4892  755]
 [ 289  215]]</code></pre>
</div>
</div>
</section>
</section>
<section id="xgboost" class="level2">
<h2 class="anchored" data-anchor-id="xgboost">4.3 XGBoost</h2>
<ul>
<li>This section implements a full XGBoost classification pipeline using a scaled 60/20/20 train/val/test split.
<ul>
<li>We begin with an initial model using default hyperparameters and evaluate performance using AUC, precision, recall, and F1 score.</li>
<li>Next, we tune the model using Optuna with a validation split nested inside the training set. The tuning objective maximizes AUC.</li>
<li>After hyperparameter tuning, we retrain the model on the full training set using the best parameters.</li>
<li>We then sweep through decision thresholds from 0.05 to 0.95 to identify the threshold that maximizes F1 score, balancing precision and recall.</li>
<li>Final model performance is evaluated on the held-out test set using the optimal threshold.</li>
</ul></li>
</ul>
<section id="initial-model-default-parameters-1" class="level3">
<h3 class="anchored" data-anchor-id="initial-model-default-parameters-1">Initial model (default parameters)</h3>
<div id="e346b727-f977-4056-86bb-9010aab46399" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}">
<div class="cell-output cell-output-stdout">
<pre><code>Initial XGBoost (Threshold = 0.5)
AUC: 0.7615
              precision    recall  f1-score   support

           0      0.919     0.999     0.957      5647
           1      0.429     0.012     0.023       504

    accuracy                          0.918      6151
   macro avg      0.674     0.505     0.490      6151
weighted avg      0.879     0.918     0.881      6151

[[5639    8]
 [ 498    6]]</code></pre>
</div>
</div>
</section>
<section id="hyperparameter-tuning-with-optuna-1" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning-with-optuna-1">Hyperparameter tuning with Optuna</h3>
<div id="325bb14d-72e5-410f-9d5d-90a23800d651" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="48">
<div class="cell-output cell-output-stdout">
<pre><code>Best AUC: 0.7791
Best parameters:
n_estimators: 877
max_depth: 5
learning_rate: 0.06263537566244079
subsample: 0.8697660901175297
colsample_bytree: 0.8110399488499476
scale_pos_weight: 3.0941905483954972</code></pre>
</div>
</div>
</section>
<section id="retrain-and-threshold-tuning-1" class="level3">
<h3 class="anchored" data-anchor-id="retrain-and-threshold-tuning-1">Retrain and threshold tuning</h3>
<div id="b747b076-0e1b-4446-954e-72a8a8fc1526" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="49">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold Sweep:
Threshold: 0.05 | Precision: 0.160 | Recall: 0.681 | F1: 0.259
Threshold: 0.10 | Precision: 0.202 | Recall: 0.508 | F1: 0.289
Threshold: 0.15 | Precision: 0.235 | Recall: 0.401 | F1: 0.297
Threshold: 0.20 | Precision: 0.257 | Recall: 0.313 | F1: 0.283
Threshold: 0.25 | Precision: 0.281 | Recall: 0.246 | F1: 0.262
Threshold: 0.30 | Precision: 0.304 | Recall: 0.198 | F1: 0.240
Threshold: 0.35 | Precision: 0.307 | Recall: 0.157 | F1: 0.208
Threshold: 0.40 | Precision: 0.332 | Recall: 0.131 | F1: 0.188
Threshold: 0.45 | Precision: 0.371 | Recall: 0.111 | F1: 0.171
Threshold: 0.50 | Precision: 0.393 | Recall: 0.095 | F1: 0.153
Threshold: 0.55 | Precision: 0.421 | Recall: 0.079 | F1: 0.134
Threshold: 0.60 | Precision: 0.389 | Recall: 0.056 | F1: 0.097
Threshold: 0.65 | Precision: 0.423 | Recall: 0.044 | F1: 0.079
Threshold: 0.70 | Precision: 0.486 | Recall: 0.034 | F1: 0.063
Threshold: 0.75 | Precision: 0.520 | Recall: 0.026 | F1: 0.049
Threshold: 0.80 | Precision: 0.545 | Recall: 0.012 | F1: 0.023
Threshold: 0.85 | Precision: 0.500 | Recall: 0.004 | F1: 0.008
Threshold: 0.90 | Precision: 0.500 | Recall: 0.002 | F1: 0.004</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-50-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best Threshold = 0.15 with F1 = 0.297</code></pre>
</div>
</div>
</section>
</section>
<section id="catboost" class="level2">
<h2 class="anchored" data-anchor-id="catboost">4.4 CatBoost</h2>
<ul>
<li>In this section, we train and evaluate a CatBoostClassifier, a gradient boosting model that natively handles categorical variables and does not require feature scaling.</li>
<li>We use the unscaled input features (X_train_unscaled, X_test_unscaled) because CatBoost handles raw numerical ranges internally and is often robust to feature distributions.</li>
<li>A baseline model is trained first with default hyperparameters.</li>
<li>We then use Optuna with a SuccessiveHalvingPruner to tune critical parameters (e.g., depth, learning_rate, l2_leaf_reg, and class weights) to maximize AUC on a validation set.</li>
<li>The best parameters are manually re-used in a retraining step.</li>
<li>A threshold sweep is conducted to identify the optimal cutoff probability for classification, targeting the best F1 score.</li>
<li>Finally, we evaluate the model using the optimal threshold and report AUC, precision, recall, and the full classification report.</li>
</ul>
<section id="initial-run" class="level3">
<h3 class="anchored" data-anchor-id="initial-run">Initial run</h3>
<div id="21926b6a-489c-44c0-b820-bebac3ab64c5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="51">
<div class="cell-output cell-output-stdout">
<pre><code>Initial Run (Threshold = 0.5)
AUC: 0.7552
              precision    recall  f1-score   support

           0      0.919     0.999     0.957      5647
           1      0.545     0.012     0.023       504

    accuracy                          0.918      6151
   macro avg      0.732     0.506     0.490      6151
weighted avg      0.888     0.918     0.881      6151

[[5642    5]
 [ 498    6]]</code></pre>
</div>
</div>
</section>
<section id="optuna-tuning" class="level3">
<h3 class="anchored" data-anchor-id="optuna-tuning">Optuna Tuning</h3>
<div id="5f0c9a4b-fd2d-4755-8fc1-c7b222d370fb" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="53">
<div class="cell-output cell-output-stdout">
<pre><code>Best AUC: 0.7769934009398187
Best Parameters:
learning_rate: 0.017401062497184344
depth: 4
l2_leaf_reg: 6.11798718499005</code></pre>
</div>
</div>
</section>
<section id="retrain-on-full-trainval-with-best-params" class="level3">
<h3 class="anchored" data-anchor-id="retrain-on-full-trainval-with-best-params">Retrain on full train/val with best params</h3>
<div id="e0386970" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}">
<div class="cell-output cell-output-stdout">
<pre><code>0:  test: 0.6639175 best: 0.6639175 (0) total: 27.9ms   remaining: 27.8s
100:    test: 0.7372920 best: 0.7374698 (99)    total: 2.61s    remaining: 23.2s
200:    test: 0.7474091 best: 0.7475647 (198)   total: 5.35s    remaining: 21.3s
300:    test: 0.7544342 best: 0.7544781 (299)   total: 7.95s    remaining: 18.5s
400:    test: 0.7580268 best: 0.7580792 (397)   total: 10.6s    remaining: 15.8s
500:    test: 0.7595591 best: 0.7595591 (500)   total: 13.2s    remaining: 13.1s
600:    test: 0.7621577 best: 0.7623123 (595)   total: 15.7s    remaining: 10.4s
700:    test: 0.7640273 best: 0.7641004 (699)   total: 18.3s    remaining: 7.81s
800:    test: 0.7652799 best: 0.7653361 (784)   total: 21s  remaining: 5.21s
Stopped by overfitting detector  (50 iterations wait)

bestTest = 0.7660887506
bestIteration = 844

Shrink model to first 845 iterations.</code></pre>
</div>
</div>
</section>
<section id="threshold-tuning" class="level3">
<h3 class="anchored" data-anchor-id="threshold-tuning">Threshold tuning</h3>
<div id="29861a4f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="55">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold Tuning Results
Threshold: 0.05 | Precision: 0.082 | Recall: 1.000 | F1: 0.151
Threshold: 0.10 | Precision: 0.083 | Recall: 0.996 | F1: 0.153
Threshold: 0.15 | Precision: 0.086 | Recall: 0.994 | F1: 0.158
Threshold: 0.20 | Precision: 0.090 | Recall: 0.984 | F1: 0.166
Threshold: 0.25 | Precision: 0.097 | Recall: 0.970 | F1: 0.176
Threshold: 0.30 | Precision: 0.106 | Recall: 0.946 | F1: 0.190
Threshold: 0.35 | Precision: 0.115 | Recall: 0.913 | F1: 0.205
Threshold: 0.40 | Precision: 0.127 | Recall: 0.877 | F1: 0.221
Threshold: 0.45 | Precision: 0.138 | Recall: 0.819 | F1: 0.237
Threshold: 0.50 | Precision: 0.154 | Recall: 0.760 | F1: 0.256
Threshold: 0.55 | Precision: 0.178 | Recall: 0.704 | F1: 0.284
Threshold: 0.60 | Precision: 0.203 | Recall: 0.619 | F1: 0.305
Threshold: 0.65 | Precision: 0.223 | Recall: 0.516 | F1: 0.311
Threshold: 0.70 | Precision: 0.248 | Recall: 0.393 | F1: 0.304
Threshold: 0.75 | Precision: 0.275 | Recall: 0.284 | F1: 0.279
Threshold: 0.80 | Precision: 0.347 | Recall: 0.190 | F1: 0.246
Threshold: 0.85 | Precision: 0.393 | Recall: 0.087 | F1: 0.143
Threshold: 0.90 | Precision: 0.478 | Recall: 0.022 | F1: 0.042</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-54-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best Threshold = 0.65 with F1 = 0.311</code></pre>
</div>
</div>
</section>
<section id="final-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="final-evaluation">Final evaluation</h3>
<div id="39dcf685" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="56">
<div class="cell-output cell-output-stdout">
<pre><code>Final Evaluation (Threshold = 0.65)
AUC: 0.7661
              precision    recall  f1-score   support

           0      0.951     0.839     0.892      5647
           1      0.223     0.516     0.311       504

    accuracy                          0.813      6151
   macro avg      0.587     0.678     0.601      6151
weighted avg      0.891     0.813     0.844      6151

[[4739  908]
 [ 244  260]]</code></pre>
</div>
</div>
</section>
</section>
<section id="lightgbm" class="level2">
<h2 class="anchored" data-anchor-id="lightgbm">4.5 LightGBM</h2>
<ul>
<li>In this section, we implement and evaluate a LightGBM (LGBM) classifier for binary classification.</li>
<li>LightGBM is a gradient boosting framework known for its speed and efficiency, particularly with large datasets and sparse features.</li>
<li>Since LightGBM does not handle special characters in feature names, we first sanitize column headers to ensure compatibility.</li>
<li>We begin by training a baseline LightGBM model using the scaled training set.</li>
<li>Probabilistic outputs are used to calculate ROC-AUC and generate default threshold classification metrics.</li>
<li>Next, we perform hyperparameter tuning using Optuna to maximize AUC on a validation subset of the training data.</li>
<li>The best parameters are then used to retrain the model on the full training set.</li>
<li>To further optimize performance, we sweep through a range of classification thresholds (0.05 to 0.95) and evaluate precision, recall, and F1 scores at each point.</li>
</ul>
<section id="initial-run-1" class="level3">
<h3 class="anchored" data-anchor-id="initial-run-1">Initial run</h3>
<div id="95b08ab2-f829-49d1-b789-4990adc82497" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="58">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold: 0.05 | Precision: 0.115 | Recall: 0.851 | F1: 0.203
Threshold: 0.10 | Precision: 0.139 | Recall: 0.740 | F1: 0.234
Threshold: 0.15 | Precision: 0.153 | Recall: 0.619 | F1: 0.246
Threshold: 0.20 | Precision: 0.176 | Recall: 0.562 | F1: 0.268
Threshold: 0.25 | Precision: 0.189 | Recall: 0.482 | F1: 0.271
Threshold: 0.30 | Precision: 0.203 | Recall: 0.419 | F1: 0.273
Threshold: 0.35 | Precision: 0.220 | Recall: 0.361 | F1: 0.274
Threshold: 0.40 | Precision: 0.240 | Recall: 0.313 | F1: 0.272
Threshold: 0.45 | Precision: 0.258 | Recall: 0.268 | F1: 0.263
Threshold: 0.50 | Precision: 0.271 | Recall: 0.214 | F1: 0.239
Threshold: 0.55 | Precision: 0.307 | Recall: 0.192 | F1: 0.237
Threshold: 0.60 | Precision: 0.340 | Recall: 0.163 | F1: 0.220
Threshold: 0.65 | Precision: 0.371 | Recall: 0.137 | F1: 0.200
Threshold: 0.70 | Precision: 0.388 | Recall: 0.099 | F1: 0.158
Threshold: 0.75 | Precision: 0.396 | Recall: 0.071 | F1: 0.121
Threshold: 0.80 | Precision: 0.456 | Recall: 0.052 | F1: 0.093
Threshold: 0.85 | Precision: 0.486 | Recall: 0.036 | F1: 0.067
Threshold: 0.90 | Precision: 0.412 | Recall: 0.014 | F1: 0.027</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-56-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best Threshold = 0.35 with F1 = 0.274

Final Evaluation (Test Set) – Threshold = 0.35
AUC: 0.7296
              precision    recall  f1-score   support

           0      0.940     0.884     0.911      5647
           1      0.221     0.369     0.276       504

    accuracy                          0.841      6151
   macro avg      0.580     0.626     0.594      6151
weighted avg      0.881     0.841     0.859      6151

[[4990  657]
 [ 318  186]]</code></pre>
</div>
</div>
</section>
<section id="optuna-tuning-1" class="level3">
<h3 class="anchored" data-anchor-id="optuna-tuning-1">Optuna Tuning</h3>
<div id="ce42e0e8-f361-413b-9c4f-8fc3230d9407" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-scrolled="true" data-execution_count="60">
<div class="cell-output cell-output-stdout">
<pre><code>Best AUC: 0.7512208390263649
Best Parameters:
n_estimators: 454
learning_rate: 0.01735647221222029
max_depth: 12
num_leaves: 17
subsample: 0.6216329271252681
colsample_bytree: 0.7773413401574687</code></pre>
</div>
</div>
</section>
<section id="threshold-tuning-1" class="level3">
<h3 class="anchored" data-anchor-id="threshold-tuning-1">Threshold tuning</h3>
<div id="fba386f5-2aad-4bb9-83fa-e15934f346f4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="62">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold Tuning (Validation Set)
Threshold: 0.05 | Precision: 0.131 | Recall: 0.827 | F1: 0.226
Threshold: 0.10 | Precision: 0.190 | Recall: 0.552 | F1: 0.283
Threshold: 0.15 | Precision: 0.244 | Recall: 0.401 | F1: 0.303
Threshold: 0.20 | Precision: 0.321 | Recall: 0.312 | F1: 0.316
Threshold: 0.25 | Precision: 0.348 | Recall: 0.218 | F1: 0.268
Threshold: 0.30 | Precision: 0.385 | Recall: 0.137 | F1: 0.202
Threshold: 0.35 | Precision: 0.490 | Recall: 0.099 | F1: 0.165
Threshold: 0.40 | Precision: 0.576 | Recall: 0.067 | F1: 0.121
Threshold: 0.45 | Precision: 0.632 | Recall: 0.048 | F1: 0.089
Threshold: 0.50 | Precision: 0.750 | Recall: 0.036 | F1: 0.068
Threshold: 0.55 | Precision: 0.727 | Recall: 0.016 | F1: 0.031
Threshold: 0.60 | Precision: 0.800 | Recall: 0.008 | F1: 0.016
Threshold: 0.65 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.70 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.75 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.80 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.85 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.90 | Precision: 0.000 | Recall: 0.000 | F1: 0.000</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-58-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best Threshold = 0.20 with F1 = 0.316</code></pre>
</div>
</div>
</section>
<section id="final-evaluation-1" class="level3">
<h3 class="anchored" data-anchor-id="final-evaluation-1">Final evaluation</h3>
<div id="1c0e690e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="66">
<div class="cell-output cell-output-stdout">
<pre><code>
Final Evaluation (Test Set) — Threshold = 0.20
AUC: 0.7632
              precision    recall  f1-score   support

           0      0.938     0.936     0.937      5647
           1      0.295     0.302     0.298       504

    accuracy                          0.884      6151
   macro avg      0.616     0.619     0.617      6151
weighted avg      0.885     0.884     0.884      6151

[[5284  363]
 [ 352  152]]</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="section-5-model-selection" class="level1">
<h1>Section 5: Model selection</h1>
<hr>
<section id="summary-metrics" class="level2">
<h2 class="anchored" data-anchor-id="summary-metrics">5.1 Summary metrics</h2>
<div id="24d2fa07-c50b-479d-b988-73d846291c5f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="67">
<div class="cell-output cell-output-stdout">
<pre><code>Final Model Comparison</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
</style>

<table id="T_ce4b9" class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_ce4b9_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">AUC</th>
<th id="T_ce4b9_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Precision</th>
<th id="T_ce4b9_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Recall</th>
<th id="T_ce4b9_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">F1 Score</th>
</tr>
<tr class="even">
<th class="index_name level0" data-quarto-table-cell-role="th">Model</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col3" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ce4b9_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">CatBoost</td>
<td id="T_ce4b9_row0_col0" class="data row0 col0">0.766</td>
<td id="T_ce4b9_row0_col1" class="data row0 col1">0.223</td>
<td id="T_ce4b9_row0_col2" class="data row0 col2">0.516</td>
<td id="T_ce4b9_row0_col3" class="data row0 col3">0.311</td>
</tr>
<tr class="even">
<td id="T_ce4b9_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">LightGBM</td>
<td id="T_ce4b9_row1_col0" class="data row1 col0">0.763</td>
<td id="T_ce4b9_row1_col1" class="data row1 col1">0.295</td>
<td id="T_ce4b9_row1_col2" class="data row1 col2">0.302</td>
<td id="T_ce4b9_row1_col3" class="data row1 col3">0.298</td>
</tr>
<tr class="odd">
<td id="T_ce4b9_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">XGBoost</td>
<td id="T_ce4b9_row2_col0" class="data row2 col0">0.747</td>
<td id="T_ce4b9_row2_col1" class="data row2 col1">0.235</td>
<td id="T_ce4b9_row2_col2" class="data row2 col2">0.401</td>
<td id="T_ce4b9_row2_col3" class="data row2 col3">0.297</td>
</tr>
<tr class="even">
<td id="T_ce4b9_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Random Forest</td>
<td id="T_ce4b9_row3_col0" class="data row3 col0">0.740</td>
<td id="T_ce4b9_row3_col1" class="data row3 col1">0.222</td>
<td id="T_ce4b9_row3_col2" class="data row3 col2">0.427</td>
<td id="T_ce4b9_row3_col3" class="data row3 col3">0.292</td>
</tr>
<tr class="odd">
<td id="T_ce4b9_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">Logistic Regression</td>
<td id="T_ce4b9_row4_col0" class="data row4 col0">0.722</td>
<td id="T_ce4b9_row4_col1" class="data row4 col1">0.198</td>
<td id="T_ce4b9_row4_col2" class="data row4 col2">0.431</td>
<td id="T_ce4b9_row4_col3" class="data row4 col3">0.271</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-60-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="section-6-feature-engineering" class="level1">
<h1>Section 6: Feature engineering</h1>
<hr>
<section id="feature-analysis" class="level2">
<h2 class="anchored" data-anchor-id="feature-analysis">6.1 Feature analysis</h2>
<section id="shap-function" class="level3">
<h3 class="anchored" data-anchor-id="shap-function">SHAP function</h3>
<div id="d4da164a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="68">
<div class="cell-output cell-output-stdout">
<pre><code>
Generating SHAP explanations for: CatBoost

CatBoost - Global Feature Importance</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-61-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
CatBoost - SHAP Summary Plot</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-61-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
CatBoost - SHAP Force Plot for Row 433 (Prob = 0.952)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-61-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
CatBoost - SHAP Force Plot for Row 4759 (Prob = 0.933)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-61-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
CatBoost - SHAP Force Plot for Row 5004 (Prob = 0.931)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-61-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="feature-engineering-catboost" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering-catboost">Feature engineering (CatBoost)</h3>
<div id="90545ab9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="69">
<div class="cell-output cell-output-stdout">
<pre><code>Feature engineering complete. New shape: (24601, 727)
X_train_catboost shape: (18450, 727)
X_test_catboost shape: (6151, 727)

y_train_catboost class balance:
TARGET
0    0.918103
1    0.081897
Name: proportion, dtype: float64

y_test_catboost class balance:
TARGET
0    0.918062
1    0.081938
Name: proportion, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="initial-run-catboost-with-added-features" class="level3">
<h3 class="anchored" data-anchor-id="initial-run-catboost-with-added-features">Initial run (CatBoost with added features)</h3>
<div id="e8795d27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="70">
<div class="cell-output cell-output-stdout">
<pre><code>📊 Initial CatBoost AUC: 0.7666</code></pre>
</div>
</div>
</section>
<section id="oputna-catboost-with-added-features" class="level3">
<h3 class="anchored" data-anchor-id="oputna-catboost-with-added-features">Oputna (CatBoost with added features)</h3>
<div id="52fa02e9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="72">
<div class="cell-output cell-output-stdout">
<pre><code>Best CatBoost hyperparameters: {'learning_rate': 0.018107443628869686, 'depth': 5, 'l2_leaf_reg': 6.541082945946988, 'bootstrap_type': 'MVS'}</code></pre>
</div>
</div>
</section>
<section id="threshold-tuning-catboost-with-added-features" class="level3">
<h3 class="anchored" data-anchor-id="threshold-tuning-catboost-with-added-features">Threshold tuning (CatBoost with added features)</h3>
<div id="1b5ba0be" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="74">
<div class="cell-output cell-output-stdout">
<pre><code>Threshold: 0.05 | Precision: 0.130 | Recall: 0.857 | F1: 0.226
Threshold: 0.10 | Precision: 0.200 | Recall: 0.603 | F1: 0.301
Threshold: 0.15 | Precision: 0.250 | Recall: 0.397 | F1: 0.307
Threshold: 0.20 | Precision: 0.283 | Recall: 0.270 | F1: 0.276
Threshold: 0.25 | Precision: 0.340 | Recall: 0.204 | F1: 0.255
Threshold: 0.30 | Precision: 0.418 | Recall: 0.147 | F1: 0.217
Threshold: 0.35 | Precision: 0.400 | Recall: 0.087 | F1: 0.143
Threshold: 0.40 | Precision: 0.431 | Recall: 0.062 | F1: 0.108
Threshold: 0.45 | Precision: 0.419 | Recall: 0.036 | F1: 0.066
Threshold: 0.50 | Precision: 0.391 | Recall: 0.018 | F1: 0.034
Threshold: 0.55 | Precision: 0.412 | Recall: 0.014 | F1: 0.027
Threshold: 0.60 | Precision: 0.600 | Recall: 0.012 | F1: 0.023
Threshold: 0.65 | Precision: 0.750 | Recall: 0.006 | F1: 0.012
Threshold: 0.70 | Precision: 0.500 | Recall: 0.002 | F1: 0.004
Threshold: 0.75 | Precision: 1.000 | Recall: 0.002 | F1: 0.004
Threshold: 0.80 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.85 | Precision: 0.000 | Recall: 0.000 | F1: 0.000
Threshold: 0.90 | Precision: 0.000 | Recall: 0.000 | F1: 0.000

Best Threshold = 0.15 with F1 = 0.307</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="section-7-final-model-catboost-with-added-features---retrain-with-all-available-data" class="level1">
<h1>Section 7: Final model (CatBoost with added features) - retrain with all available data</h1>
<hr>
<div id="fff0fc4c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;jupyter&quot;,&quot;value&quot;:{&quot;source_hidden&quot;:true}}" data-execution_count="75">
<div class="cell-output cell-output-stdout">
<pre><code>Fold 1 Confusion Matrix:
[[4102  416]
 [ 245  158]]

Fold 2 Confusion Matrix:
[[4120  397]
 [ 265  138]]

Fold 3 Confusion Matrix:
[[4072  445]
 [ 243  160]]

Fold 4 Confusion Matrix:
[[4135  382]
 [ 238  165]]

Fold 5 Confusion Matrix:
[[4079  438]
 [ 266  137]]

Cross-validated AUC: 0.7736
Cross-validated F1:  0.3125

Average Confusion Matrix Across Folds:
[[4101  415]
 [ 251  151]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_homecredit_sample_files/figure-html/cell-67-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion-and-next-steps" class="level1">
<h1>Conclusion and Next Steps</h1>
<hr>
<p>In this sample modeling notebook, we conducted a preliminary evaluation of several machine learning classifiers—Logistic Regression, Random Forest, XGBoost, LightGBM, and CatBoost—on a representative subset of the Home Credit Default Risk dataset. Our objective was to quickly assess model behavior, test the effectiveness of engineered features, and refine our modeling pipeline prior to scaling.</p>
<section id="key-takeaways-from-sample-evaluation" class="level4">
<h4 class="anchored" data-anchor-id="key-takeaways-from-sample-evaluation">Key Takeaways from Sample Evaluation:</h4>
<ul>
<li>CatBoostClassifier delivered the strongest overall results, achieving the highest AUC and recall after threshold tuning. Its native handling of categorical features and robust regularization made it well-suited for this tabular dataset.</li>
<li>XGBoost and LightGBM were competitive in AUC but required more manual preprocessing and did not match CatBoost’s recall performance out of the box.</li>
<li>Logistic Regression provided a useful linear baseline but underperformed in F1 and recall, suggesting limited ability to capture complex feature interactions.</li>
<li>Random Forest offered decent performance but lacked the optimization granularity and recall sensitivity of boosting methods.</li>
</ul>
<p>These results validate our modeling approach and establish a strong foundation for full-scale modeling.</p>
<p>We will now proceed to the full notebook, where we: - Load and preprocess the complete training data, merging all 7 relational tables. - Apply our finalized feature engineering pipeline, including over 500 features such as credit ratios, external risk scores, and time-based repayment behavior. - Perform hyperparameter tuning with Optuna to maximize AUC, while prioritizing recall as the key business metric. - Train the final CatBoost model on the full dataset using stratified K-Fold cross-validation. - Interpret global and local model behavior using SHAP for transparency. - Generate test set predictions and export a probability-based output for submission or deployment.</p>
<p>Continue to the Full Modeling Notebook for complete end-to-end training on the entire Home Credit dataset.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>